<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campagne ‚Äî Hardscrapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: '#dc2626' } } } }
    </script>
    <style>
        .nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:.75rem .5rem;color:#9ca3af;border-radius:.5rem;transition:all .2s;cursor:pointer;background:none;border:none;text-decoration:none}
        .nav-btn:hover{background:#374151;color:#f3f4f6}.nav-btn.active{background:#374151;color:#dc2626}
        .card{background:#1f2937;border:1px solid #374151;border-radius:.75rem;padding:1.5rem}
        .card-sm{background:#1f2937;border:1px solid #374151;border-radius:.75rem;padding:1rem}
        .btn-primary{background:#dc2626;color:white;padding:.5rem 1.25rem;border-radius:.5rem;font-weight:600;transition:all .2s;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:.5rem}
        .btn-primary:hover{background:#b91c1c}.btn-primary:disabled{background:#6b7280;cursor:not-allowed}
        .btn-secondary{background:#374151;color:#f3f4f6;padding:.5rem 1.25rem;border-radius:.5rem;font-weight:500;transition:all .2s;border:1px solid #4b5563;cursor:pointer;display:inline-flex;align-items:center;gap:.5rem}
        .btn-secondary:hover{background:#4b5563}
        .form-input{background:#111827;border:1px solid #374151;color:#f3f4f6;border-radius:.5rem;padding:.5rem .75rem;width:100%;transition:border-color .2s}
        .form-input:focus{outline:none;border-color:#dc2626}
        .form-textarea{background:#111827;border:1px solid #374151;color:#f3f4f6;border-radius:.5rem;padding:.75rem;width:100%;resize:vertical;font-family:monospace;font-size:.875rem;transition:border-color .2s}
        .form-textarea:focus{outline:none;border-color:#dc2626}
        .preset-btn{background:#111827;border:1px solid #374151;color:#9ca3af;padding:.4rem .75rem;border-radius:.5rem;font-size:.8rem;cursor:pointer;transition:all .2s;white-space:nowrap}
        .preset-btn:hover{border-color:#dc2626;color:#f3f4f6}.preset-btn.active{border-color:#dc2626;color:#dc2626;background:#1f2937}
        .preset-btn-test{background:#1a1025;border:1px solid #6b21a8;color:#a78bfa;padding:.4rem .75rem;border-radius:.5rem;font-size:.8rem;cursor:pointer;transition:all .2s;white-space:nowrap}
        .preset-btn-test:hover{border-color:#a855f7;color:#c4b5fd;background:#1e1035}
        .preset-btn-test.active{border-color:#a855f7;color:#a855f7;background:#2e1065}
        .slider{-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;background:#374151;outline:none;width:100%}
        .slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#dc2626;cursor:pointer}
        .toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:.875rem 1.25rem;border-radius:.5rem;font-weight:500;z-index:9999;transform:translateY(100px);opacity:0;transition:all .3s}
        .toast.show{transform:translateY(0);opacity:1}.toast.success{background:#16a34a;color:white}.toast.error{background:#dc2626;color:white}
        .tab-btn{padding:.5rem 1rem;border-radius:.5rem .5rem 0 0;font-size:.875rem;font-weight:500;cursor:pointer;border:none;transition:all .2s}
        .tab-btn.active{background:#1f2937;color:#f3f4f6;border-bottom:2px solid #dc2626}
        .tab-btn:not(.active){background:#111827;color:#6b7280}.tab-btn:not(.active):hover{color:#9ca3af}
        .stat-card{background:#111827;border:1px solid #374151;border-radius:.5rem;padding:.875rem;text-align:center}
        .mode-btn{padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;cursor:pointer;border:1px solid #374151;background:#111827;color:#9ca3af;transition:all .2s}
        .mode-btn.active{border-color:#dc2626;color:#dc2626;background:#1f2937}
        .log-entry{font-family:monospace;font-size:.8rem;padding:.15rem 0;border-bottom:1px solid #1f2937}
        /* Bouton aide */
        .help-btn{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#374151;color:#9ca3af;font-size:10px;font-weight:700;cursor:pointer;border:none;margin-left:4px;flex-shrink:0;transition:all .15s;line-height:1}
        .help-btn:hover{background:#dc2626;color:white}
        /* Modal aide */
        .help-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
        .help-modal-overlay.open{opacity:1;pointer-events:all}
        .help-modal{background:#1f2937;border:1px solid #374151;border-radius:.75rem;padding:1.5rem;max-width:480px;width:90%;transform:scale(.95);transition:transform .2s;max-height:80vh;overflow-y:auto}
        .help-modal-overlay.open .help-modal{transform:scale(1)}
        .help-tag{display:inline-block;padding:.2rem .6rem;border-radius:.25rem;font-size:.75rem;font-weight:600;margin:.15rem}
        /* Carte D3 */
        #carte-svg path{cursor:pointer;transition:fill .15s,stroke .15s}
        #carte-svg path:hover{opacity:.85}
        #carte-svg path.selected{stroke:#ef4444;stroke-width:1.5px}
        #carte-tooltip-d3{position:absolute;background:#111827;border:1px solid #374151;color:#f3f4f6;padding:.35rem .65rem;border-radius:.375rem;font-size:.75rem;pointer-events:none;z-index:100;white-space:nowrap}
        /* Filtres population */
        .pop-filter-btn.active-pop{border-color:#dc2626;color:#dc2626;background:#1f2937}
        /* Tableau communes */
        #communes-tbody tr{border-bottom:1px solid #1f2937;transition:background .1s}
        #communes-tbody tr:hover{background:#1f2937}
        #communes-tbody tr.status-confirmed td:first-child{border-left:3px solid #16a34a}
        #communes-tbody tr.status-uncertain td:first-child{border-left:3px solid #ca8a04}
        #communes-tbody tr.status-not_found td:first-child{border-left:3px solid #dc2626;opacity:.7}
        #communes-tbody tr.status-manual td:first-child{border-left:3px solid #9333ea}
        #communes-tbody tr.status-checking td:first-child{border-left:3px solid #3b82f6}
        .status-badge{display:inline-flex;align-items:center;gap:.25rem;padding:.15rem .5rem;border-radius:.25rem;font-size:.65rem;font-weight:600;white-space:nowrap}
        .status-badge.confirmed{background:#14532d;color:#4ade80}
        .status-badge.uncertain{background:#422006;color:#fbbf24}
        .status-badge.not_found{background:#450a0a;color:#f87171}
        .status-badge.manual{background:#3b0764;color:#c084fc}
        .status-badge.checking{background:#1e3a5f;color:#60a5fa;animation:pulse 1s infinite}
        .status-badge.unknown{background:#1f2937;color:#6b7280}
        .source-badge{display:inline-block;padding:.1rem .4rem;border-radius:.2rem;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
        .source-badge.pattern{background:#1e3a5f;color:#93c5fd}
        .source-badge.groq{background:#3b0764;color:#d8b4fe}
        .source-badge.manual{background:#1c1917;color:#a8a29e}
        .source-badge.none,.source-badge.groq_failed{background:#1f2937;color:#4b5563}
        .url-edit-input{background:transparent;border:none;outline:none;color:#60a5fa;width:100%;font-size:.7rem;cursor:pointer}
        .url-edit-input:focus{background:#111827;border:1px solid #3b82f6;border-radius:.25rem;padding:.1rem .3rem;color:#93c5fd}
        /* Lignes communes (ancien style conserv√© pour compat) */
        .commune-row{display:flex;align-items:center;gap:.5rem;padding:.35rem .5rem;border-radius:.375rem;background:#111827;border:1px solid #1f2937}
        .url-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#4b5563}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        /* Boutons fen√™tre temporelle */
        .fenetre-btn{transition:all .15s}
        .fenetre-btn.active-fen{border-color:#dc2626!important;color:#f87171!important;background:rgba(220,38,38,.12)!important}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- Modal aide -->
<div id="help-overlay" class="help-modal-overlay" onclick="fermerAide(event)">
    <div class="help-modal">
        <div class="flex items-start justify-between mb-3">
            <h3 id="help-title" class="text-base font-bold text-white"></h3>
            <button onclick="fermerAide()" class="text-gray-500 hover:text-white ml-4 text-lg leading-none">&times;</button>
        </div>
        <div id="help-body" class="text-sm text-gray-300 space-y-2"></div>
    </div>
</div>

<!-- Main -->
<main class="min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-gray-800 border-b border-gray-700 px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i data-lucide="crosshair" class="w-5 h-5 text-red-500"></i>
            <h1 class="text-lg font-bold text-white">Hardscrapper</h1>
            <span class="text-gray-500 text-sm">|</span>
            <span id="header-campagne-nom" class="text-sm text-red-400 font-medium">chargement...</span>
        </div>
        <div class="flex gap-2">
            <button onclick="sauvegarder()" class="btn-secondary text-sm py-1.5">
                <i data-lucide="save" class="w-4 h-4"></i>Sauvegarder config
            </button>
            <button onclick="lancerScraping()" id="btn-lancer" class="btn-primary text-sm py-1.5">
                <i data-lucide="play" class="w-4 h-4"></i>Lancer la recherche
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-gray-900 border-b border-gray-700 px-6 flex gap-1 pt-2">
        <button class="tab-btn active" id="tab-config" onclick="showTab('config')">
            <i data-lucide="settings-2" class="w-4 h-4 inline mr-1"></i>Configuration
        </button>
        <button class="tab-btn" id="tab-lancement" onclick="showTab('lancement')">
            <i data-lucide="globe" class="w-4 h-4 inline mr-1"></i>Lancement
        </button>
        <button class="tab-btn" id="tab-resultats" onclick="showTab('resultats')">
            <i data-lucide="bar-chart-2" class="w-4 h-4 inline mr-1"></i>R√©sultats
        </button>
        <button class="tab-btn" id="tab-documents" onclick="showTab('documents')">
            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>Documents
        </button>
    </div>

    <div class="p-6">
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB CONFIG -->
    <div id="pane-config" class="tab-pane">
        <!-- Presets -->
        <div class="card mb-5">
            <div class="flex items-center gap-2 mb-3">
                <i data-lucide="zap" class="w-4 h-4 text-red-500"></i>
                <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Presets pr√©d√©finis</span>
                <button class="help-btn" onclick="aide('presets')">?</button>
            </div>
            <div class="flex flex-wrap gap-2">
                <button class="preset-btn active" onclick="appliquerPreset('chaufferies_biomasse',this)">üî• Chaufferies Biomasse</button>
                <button class="preset-btn" onclick="appliquerPreset('panneaux_solaires',this)">‚òÄÔ∏è Panneaux Solaires</button>
                <button class="preset-btn" onclick="appliquerPreset('pompes_chaleur',this)">‚ô®Ô∏è Pompes √† Chaleur</button>
                <button class="preset-btn" onclick="appliquerPreset('bornes_recharge',this)">‚ö° Bornes Recharge VE</button>
                <button class="preset-btn" onclick="appliquerPreset('renovation_batiments',this)">üèóÔ∏è R√©novation B√¢timents</button>
                <button class="preset-btn" onclick="appliquerPreset('custom',this)">‚úèÔ∏è Personnalis√©</button>
                <button class="preset-btn-test" onclick="appliquerPreset('mode_test',this)" title="Mode diagnostic ‚Äî mots-cl√©s larges et seuils bas pour v√©rifier que le pipeline scraping fonctionne correctement.">üß™ Mode Test</button>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-5">
            <!-- Colonne 1+2 : Infos + Mots-cl√©s -->
            <div class="col-span-2 space-y-5">
                <!-- Infos campagne -->
                <div class="card">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="info" class="w-4 h-4 text-red-500"></i>
                        <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Informations</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1 flex items-center">Nom de la campagne</label>
                            <input type="text" id="nom_campagne" class="form-input" placeholder="Ex: Chaufferies Biomasse AURA 2026">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Date de d√©but de recherche</label>
                            <input type="date" id="date_debut_recherche" class="form-input">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-gray-400 mb-1">Description</label>
                            <input type="text" id="description" class="form-input" placeholder="Objectif de la campagne">
                        </div>
                    </div>
                </div>

                <!-- Mots-cl√©s -->
                <div class="card">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="tag" class="w-4 h-4 text-red-500"></i>
                        <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Mots-cl√©s de d√©tection</span>
                        <button class="help-btn" onclick="aide('mots_cles')">?</button>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-red-400 uppercase flex items-center gap-1">
                                    Prioritaires
                                    <button class="help-btn" onclick="aide('mots_prioritaires')">?</button>
                                </span>
                                <span class="text-xs bg-red-900/40 text-red-400 px-2 py-0.5 rounded">√ó 2 pts</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Un mot par ligne</p>
                            <textarea id="mots_prioritaires" class="form-textarea" rows="8" placeholder="chaufferie&#10;biomasse&#10;r√©seau chaleur"></textarea>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-yellow-400 uppercase flex items-center gap-1">
                                    Secondaires
                                    <button class="help-btn" onclick="aide('mots_secondaires')">?</button>
                                </span>
                                <span class="text-xs bg-yellow-900/40 text-yellow-400 px-2 py-0.5 rounded">√ó 1 pt</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Un mot par ligne</p>
                            <textarea id="mots_secondaires" class="form-textarea" rows="8" placeholder="chauffage bois&#10;granul√©s&#10;plaquettes"></textarea>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-green-400 uppercase flex items-center gap-1">
                                    Budget
                                    <button class="help-btn" onclick="aide('mots_budget')">?</button>
                                </span>
                                <span class="text-xs bg-green-900/40 text-green-400 px-2 py-0.5 rounded">√ó 1 pt</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Un mot par ligne</p>
                            <textarea id="mots_budget" class="form-textarea" rows="8" placeholder="budget&#10;subvention&#10;ademe"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne 3 : Param√®tres -->
            <div class="space-y-5">
                <!-- Seuils -->
                <div class="card">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="sliders" class="w-4 h-4 text-red-500"></i>
                        <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Seuils</span>
                        <button class="help-btn" onclick="aide('seuils')">?</button>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between mb-1 items-center">
                                <label class="text-xs text-gray-400 flex items-center gap-1">
                                    Score minimum scraping
                                    <button class="help-btn" onclick="aide('seuil_scraping')">?</button>
                                </label>
                                <span id="seuil_label" class="text-red-400 font-bold">2</span>
                            </div>
                            <input type="range" id="seuil_confiance" class="slider" min="1" max="5" value="2"
                                oninput="document.getElementById('seuil_label').textContent=this.value">
                            <div class="flex justify-between text-xs text-gray-600 mt-1"><span>Large</span><span>Strict</span></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1 items-center">
                                <label class="text-xs text-gray-400 flex items-center gap-1">
                                    Score IA minimum (/10)
                                    <button class="help-btn" onclick="aide('seuil_ia')">?</button>
                                </label>
                                <span id="seuil_ia_label" class="text-red-400 font-bold">7</span>
                            </div>
                            <input type="range" id="seuil_ia" class="slider" min="1" max="10" value="7"
                                oninput="document.getElementById('seuil_ia_label').textContent=this.value">
                            <div class="flex justify-between text-xs text-gray-600 mt-1"><span>Tout</span><span>Parfait</span></div>
                        </div>
                    </div>
                </div>

                <!-- Param√®tres scraping -->
                <div class="card">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="settings-2" class="w-4 h-4 text-red-500"></i>
                        <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Scraping</span>
                        <button class="help-btn" onclick="aide('params_scraping')">?</button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                D√©lai entre requ√™tes (s)
                                <button class="help-btn" onclick="aide('delai')">?</button>
                            </label>
                            <input type="number" id="delai_requetes" class="form-input" value="1.5" min="0.5" max="10" step="0.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                Timeout (s)
                                <button class="help-btn" onclick="aide('timeout')">?</button>
                            </label>
                            <input type="number" id="timeout" class="form-input" value="30" min="5" max="120" step="5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                Profondeur
                                <button class="help-btn" onclick="aide('profondeur')">?</button>
                            </label>
                            <select id="profondeur" class="form-input">
                                <option value="leger">L√©ger ‚Äî page principale</option>
                                <option value="moyen" selected>Moyen ‚Äî sections principales</option>
                                <option value="profond">Profond ‚Äî toutes sous-pages</option>
                            </select>
                        </div>

                        <!-- Fen√™tre temporelle -->
                        <div class="pt-2 border-t border-gray-700">
                            <label class="block text-xs text-gray-400 mb-2 flex items-center gap-1">
                                <i data-lucide="calendar-range" class="w-3 h-3"></i>
                                Fen√™tre temporelle
                                <button class="help-btn" onclick="aide('fenetre_temporelle')">?</button>
                            </label>
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="setFenetre(30)"  id="fen-30"  class="fenetre-btn text-xs px-2 py-1 rounded border border-gray-600 text-gray-400 hover:border-red-500 hover:text-red-400 transition-colors">30j</button>
                                <button onclick="setFenetre(60)"  id="fen-60"  class="fenetre-btn text-xs px-2 py-1 rounded border border-gray-600 text-gray-400 hover:border-red-500 hover:text-red-400 transition-colors">60j</button>
                                <button onclick="setFenetre(90)"  id="fen-90"  class="fenetre-btn text-xs px-2 py-1 rounded border border-red-600 text-red-400 bg-red-900/20 transition-colors active-fen">90j</button>
                                <button onclick="setFenetre(180)" id="fen-180" class="fenetre-btn text-xs px-2 py-1 rounded border border-gray-600 text-gray-400 hover:border-red-500 hover:text-red-400 transition-colors">180j</button>
                            </div>
                            <input type="hidden" id="fenetre_temporelle" value="90">
                        </div>

                        <!-- Signaux faibles -->
                        <div class="pt-2 border-t border-gray-700">
                            <label class="block text-xs text-gray-400 mb-2 flex items-center gap-1">
                                <i data-lucide="radar" class="w-3 h-3"></i>
                                Signaux faibles actifs
                            </label>
                            <div class="space-y-1.5">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="sf-budgetaires" class="accent-yellow-500" checked>
                                    <span class="text-xs text-gray-300">üí∞ Signaux budg√©taires <span class="text-gray-600">(PPI, budget primitif‚Ä¶)</span></span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="sf-reflexion" class="accent-green-500" checked>
                                    <span class="text-xs text-gray-300">üü¢ Signaux de r√©flexion <span class="text-gray-600">(audit, PCAET, DPE‚Ä¶)</span></span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="sf-consultation" class="accent-red-500" checked>
                                    <span class="text-xs text-gray-300">üî¥ Signaux de consultation <span class="text-gray-600">(AMI, DCE, AO‚Ä¶)</span></span>
                                </label>
                            </div>
                        </div>

                        <!-- Maturit√© minimale -->
                        <div class="pt-2 border-t border-gray-700">
                            <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                <i data-lucide="filter" class="w-3 h-3"></i>
                                Maturit√© minimale √† afficher
                            </label>
                            <select id="maturite_min" class="form-input text-xs">
                                <option value="reflexion">üü¢ R√©flexion (tous)</option>
                                <option value="etude">üü° √âtude (6-12 mois)</option>
                                <option value="programmation">üü† Programmation (3-6 mois)</option>
                                <option value="consultation">üî¥ Consultation imminente (&lt; 3 mois)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Analyse IA -->
                <div class="card">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="cpu" class="w-4 h-4 text-red-500"></i>
                        <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Analyse IA</span>
                        <button class="help-btn" onclick="aide('ia_mode')">?</button>
                    </div>
                    <div class="space-y-3">
                        <!-- Mode -->
                        <div>
                            <label class="block text-xs text-gray-400 mb-2">Mode d'analyse</label>
                            <div class="flex flex-col gap-2" id="ia-mode-btns">
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg border border-gray-700 hover:border-red-600 transition-colors" id="ia-mode-local-lbl">
                                    <input type="radio" name="ia_mode" value="local" class="accent-red-500" onchange="onIaModeChange('local')">
                                    <div>
                                        <div class="text-xs font-semibold text-gray-200">ü§ñ IA locale (TinyLlama)</div>
                                        <div class="text-xs text-gray-500">Ollama sur votre machine ‚Äî priv√©, hors-ligne</div>
                                    </div>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg border border-gray-700 hover:border-red-600 transition-colors" id="ia-mode-groq-lbl">
                                    <input type="radio" name="ia_mode" value="groq" class="accent-red-500" onchange="onIaModeChange('groq')">
                                    <div>
                                        <div class="text-xs font-semibold text-gray-200">‚òÅÔ∏è API Groq (cloud)</div>
                                        <div class="text-xs text-gray-500">Rapide, gratuit jusqu'√† 30 req/min</div>
                                    </div>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg border border-gray-700 hover:border-red-600 transition-colors" id="ia-mode-manuel-lbl">
                                    <input type="radio" name="ia_mode" value="manuel" class="accent-red-500" onchange="onIaModeChange('manuel')">
                                    <div>
                                        <div class="text-xs font-semibold text-gray-200">‚úã Validation manuelle</div>
                                        <div class="text-xs text-gray-500">Vous validez chaque document vous-m√™me</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <!-- Options Groq (cach√©es par d√©faut) -->
                        <div id="ia-groq-options" class="hidden space-y-2 pt-2 border-t border-gray-700">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Cl√© API Groq</label>
                                <input type="password" id="groq-api-key" class="form-input text-xs" placeholder="gsk_...">
                                <p class="text-xs text-gray-600 mt-1">Gratuit sur <a href="https://console.groq.com" target="_blank" class="text-red-400 hover:underline">console.groq.com</a></p>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Mod√®le Groq</label>
                                <select id="groq-model" class="form-input text-xs">
                                    <option value="llama3-8b-8192">Llama 3 8B (rapide)</option>
                                    <option value="llama3-70b-8192">Llama 3 70B (pr√©cis)</option>
                                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                                    <option value="gemma2-9b-it">Gemma 2 9B</option>
                                </select>
                            </div>
                        </div>
                        <!-- Options Local (cach√©es si autre mode) -->
                        <div id="ia-local-options" class="space-y-2 pt-2 border-t border-gray-700">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Mod√®le local</label>
                                <select id="local-model" class="form-input text-xs">
                                    <option value="tinyllama">TinyLlama 1B ‚úÖ recommand√© M1</option>
                                    <option value="mistral">Mistral 7B (lourd)</option>
                                    <option value="llama2">Llama2 7B (lourd)</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="sauvegarderConfigIA()" class="btn-secondary w-full justify-center text-xs py-1.5">
                            <i data-lucide="save" class="w-3 h-3"></i>Sauvegarder config IA
                        </button>
                    </div>
                </div>

                <button onclick="resetConfig()" class="btn-secondary w-full justify-center text-sm">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>R√©initialiser par d√©faut
                </button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB LANCEMENT -->
    <div id="pane-lancement" class="tab-pane hidden">
        <div class="grid grid-cols-2 gap-5">
            <!-- Cibles -->
            <div class="card">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="globe" class="w-4 h-4 text-red-500"></i>
                    <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Sites √† scraper</span>
                    <button class="help-btn" onclick="aide('sites_scraper')">?</button>
                </div>
                <div class="flex gap-2 mb-4">
                    <button class="mode-btn active" id="mode-single" onclick="setMode('single')">
                        <i data-lucide="link" class="w-4 h-4 inline mr-1"></i>URLs manuelles
                    </button>
                    <button class="mode-btn" id="mode-dept" onclick="setMode('department')">
                        <i data-lucide="map" class="w-4 h-4 inline mr-1"></i>Par d√©partement
                    </button>
                </div>

                <!-- Mode URL -->
                <div id="mode-single-panel">
                    <div class="flex gap-2 mb-2">
                        <button onclick="chargerCommunesAuvergne()" class="btn-secondary text-xs py-1">
                            <i data-lucide="mountain" class="w-3 h-3"></i>Charger AURA
                        </button>
                        <div class="flex items-center gap-1 text-xs text-gray-400">
                            Pop. min :
                            <input type="number" id="auvergne-min-pop" value="5000" min="0" step="1000"
                                class="w-20 px-2 py-1 bg-gray-900 border border-gray-600 rounded text-white text-xs">
                        </div>
                    </div>
                    <label class="block text-xs text-gray-400 mb-1">URLs (une par ligne)</label>
                    <textarea id="urls-input" class="form-textarea" rows="10"
                        placeholder="https://www.thiers.fr&#10;https://www.ambert.fr"></textarea>
                </div>

                <!-- Mode d√©partement ‚Äî Carte D3 -->
                <div id="mode-dept-panel" class="hidden">
                    <div class="flex gap-3 mb-3 items-end flex-wrap">
                        <div class="flex-1 min-w-40">
                            <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                S√©lection rapide par r√©gion
                                <button class="help-btn" onclick="aide('regions')">?</button>
                            </label>
                            <select id="region-select" class="form-input" onchange="selectionnerRegion(this.value)">
                                <option value="">‚Äî Choisir une r√©gion ‚Äî</option>
                                <option value="aura">Auvergne-Rh√¥ne-Alpes</option>
                                <option value="idf">√éle-de-France</option>
                                <option value="occ">Occitanie</option>
                                <option value="naq">Nouvelle-Aquitaine</option>
                                <option value="bfc">Bourgogne-Franche-Comt√©</option>
                                <option value="paca">PACA</option>
                                <option value="bre">Bretagne</option>
                                <option value="nor">Normandie</option>
                                <option value="hdf">Hauts-de-France</option>
                                <option value="ges">Grand Est</option>
                                <option value="pdl">Pays de la Loire</option>
                                <option value="cvl">Centre-Val de Loire</option>
                            </select>
                        </div>
                        <button onclick="deselectionnerTout()" class="btn-secondary text-xs py-1.5 shrink-0">
                            <i data-lucide="x" class="w-3 h-3"></i>Tout d√©s√©lectionner
                        </button>
                    </div>

                    <!-- Carte D3 pleine largeur + liste en overlay -->
                    <div class="relative bg-gray-900 rounded-lg border border-gray-700 overflow-hidden" style="height:480px;" id="carte-container">
                        <svg id="carte-svg" style="width:100%;height:100%;"></svg>
                        <div id="carte-tooltip-d3" class="hidden"></div>
                        <div class="absolute top-2 right-2 bg-gray-800/90 backdrop-blur-sm rounded-lg border border-gray-700 p-2" style="width:160px;">
                            <div class="text-xs text-gray-400 font-semibold mb-1">S√©lectionn√©s</div>
                            <div id="depts-selectionnes" class="space-y-1 overflow-y-auto mb-2" style="max-height:180px;"></div>
                            <div class="pt-1 border-t border-gray-700">
                                <div class="text-xs text-gray-500">Total</div>
                                <div class="text-xl font-bold text-red-400" id="nb-depts-sel">0</div>
                                <div class="text-xs text-gray-500">d√©partement(s)</div>
                            </div>
                            <div class="mt-2 space-y-1 text-xs text-gray-600">
                                <div><span class="inline-block w-2.5 h-2.5 rounded mr-1" style="background:#dc2626"></span>S√©lectionn√©</div>
                                <div><span class="inline-block w-2.5 h-2.5 rounded mr-1" style="background:#374151"></span>Non s√©lectionn√©</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtres population + bouton charger communes -->
                    <div class="mt-3 bg-gray-800 rounded-lg border border-gray-700 p-3">
                        <div class="flex items-center gap-2 mb-3 flex-wrap">
                            <i data-lucide="users" class="w-4 h-4 text-red-500 shrink-0"></i>
                            <span class="text-xs font-semibold text-gray-300 uppercase tracking-wider">Filtre population</span>
                            <button class="help-btn" onclick="aide('population_min')">?</button>
                            <div class="flex gap-1 ml-auto flex-wrap">
                                <button onclick="setPopFilter(0,1999)" class="pop-filter-btn text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-gray-400 hover:border-red-500 hover:text-white transition-colors" data-min="0" data-max="1999">&lt; 2 000</button>
                                <button onclick="setPopFilter(2000,9999)" class="pop-filter-btn text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-gray-400 hover:border-red-500 hover:text-white transition-colors" data-min="2000" data-max="9999">2k‚Äì10k</button>
                                <button onclick="setPopFilter(10000,49999)" class="pop-filter-btn text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-gray-400 hover:border-red-500 hover:text-white transition-colors" data-min="10000" data-max="49999">10k‚Äì50k</button>
                                <button onclick="setPopFilter(50000,9999999)" class="pop-filter-btn text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-gray-400 hover:border-red-500 hover:text-white transition-colors" data-min="50000" data-max="9999999">&gt; 50k</button>
                                <button onclick="setPopFilter(0,9999999)" class="pop-filter-btn text-xs px-2 py-1 rounded border border-gray-600 bg-gray-900 text-gray-400 hover:border-red-500 hover:text-white transition-colors active-pop" data-min="0" data-max="9999999">Toutes</button>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center flex-wrap">
                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                <span>Min :</span>
                                <input type="number" id="dept-min-pop" class="form-input w-24 py-1 text-xs" value="0" min="0" step="500">
                                <span>Max :</span>
                                <input type="number" id="dept-max-pop" class="form-input w-24 py-1 text-xs" value="9999999" min="0" step="500">
                            </div>
                            <button onclick="chargerCommunesDept()" id="btn-charger-communes" class="btn-primary text-xs py-1.5 ml-auto">
                                <i data-lucide="download" class="w-3 h-3"></i>Charger les communes
                            </button>
                        </div>
                    </div>

                    <!-- Panneau communes charg√©es -->
                    <div id="communes-panel" class="hidden mt-3">
                        <div class="bg-gray-800 rounded-lg border border-gray-700 p-3">
                            <!-- En-t√™te + actions globales -->
                            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="list" class="w-4 h-4 text-red-500"></i>
                                    <span class="text-xs font-semibold text-gray-300 uppercase tracking-wider">Communes √† scraper</span>
                                    <span id="communes-count" class="text-xs bg-red-900/50 text-red-300 px-2 py-0.5 rounded-full">0</span>
                                </div>
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="validerURLsPatterns()" id="btn-valider-patterns" class="btn-secondary text-xs py-1.5">
                                        <i data-lucide="search" class="w-3 h-3"></i>√âtape 1 ‚Äî Valider patterns
                                    </button>
                                    <button onclick="lancerGroqSurNonTrouves()" id="btn-groq-search" class="hidden text-xs py-1.5 px-3 bg-purple-900/40 text-purple-300 border border-purple-700 rounded-lg hover:bg-purple-900/60 flex items-center gap-1">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i>√âtape 2 ‚Äî Groq sur non trouv√©es
                                    </button>
                                    <button onclick="supprimerNonTrouves()" id="btn-suppr-nf" class="hidden text-xs py-1.5 px-3 bg-red-900/40 text-red-400 border border-red-800 rounded-lg hover:bg-red-900/60 flex items-center gap-1">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>Retirer non trouv√©es
                                    </button>
                                </div>
                            </div>

                            <!-- Barre de progression globale -->
                            <div id="validate-progress" class="hidden mb-3">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span id="validate-progress-text">Validation en cours...</span>
                                    <span id="validate-progress-pct">0%</span>
                                </div>
                                <div class="h-1.5 bg-gray-700 rounded overflow-hidden">
                                    <div id="validate-progress-bar" class="h-full bg-red-600 transition-all duration-300" style="width:0%"></div>
                                </div>
                            </div>

                            <!-- Stats -->
                            <div id="validate-stats" class="hidden grid grid-cols-4 gap-2 mb-3">
                                <div class="stat-card py-1 text-center"><div class="text-xs text-gray-500">‚úÖ Confirm√©es</div><div class="text-lg font-bold text-green-400" id="vs-confirmed">0</div></div>
                                <div class="stat-card py-1 text-center"><div class="text-xs text-gray-500">‚ö†Ô∏è Incertaines</div><div class="text-lg font-bold text-yellow-400" id="vs-uncertain">0</div></div>
                                <div class="stat-card py-1 text-center"><div class="text-xs text-gray-500">‚ùå Non trouv√©es</div><div class="text-lg font-bold text-red-400" id="vs-notfound">0</div></div>
                                <div class="stat-card py-1 text-center"><div class="text-xs text-gray-500">üîµ Non v√©rifi√©es</div><div class="text-lg font-bold text-gray-400" id="vs-unknown">0</div></div>
                            </div>

                            <!-- Ajout manuel -->
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="add-url-input" placeholder="https://www.mairie-exemple.fr" class="form-input flex-1 text-xs py-1.5">
                                <input type="text" id="add-nom-input" placeholder="Nom commune" class="form-input w-32 text-xs py-1.5">
                                <button onclick="ajouterURLManuelle()" class="btn-secondary text-xs py-1.5 shrink-0">
                                    <i data-lucide="plus" class="w-3 h-3"></i>Ajouter
                                </button>
                            </div>

                            <!-- Tableau communes -->
                            <div class="overflow-x-auto" style="max-height:380px;overflow-y:auto;">
                                <table class="w-full text-xs" id="communes-table">
                                    <thead class="sticky top-0 bg-gray-800 z-10">
                                        <tr class="text-gray-500 uppercase text-left border-b border-gray-700">
                                            <th class="py-2 pr-3 font-semibold">Commune</th>
                                            <th class="py-2 pr-3 font-semibold">Population</th>
                                            <th class="py-2 pr-3 font-semibold" style="min-width:220px">URL retenue</th>
                                            <th class="py-2 pr-3 font-semibold">Statut</th>
                                            <th class="py-2 pr-3 font-semibold">Source</th>
                                            <th class="py-2 font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="communes-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© + Lancement + Logs -->
            <div class="space-y-4">
                <div class="card">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <i data-lucide="crosshair" class="w-4 h-4 text-red-500"></i>
                            <span class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Campagne active</span>
                        </div>
                        <button onclick="showTab('config')" class="text-xs text-red-400 hover:text-red-300">Modifier ‚Üí</button>
                    </div>
                    <p class="text-white font-medium mb-2" id="resume-nom">‚Äî</p>
                    <div class="space-y-2">
                        <div><span class="text-xs text-gray-500">Prioritaires :</span>
                            <div class="flex flex-wrap gap-1 mt-1" id="resume-prioritaires"></div></div>
                        <div><span class="text-xs text-gray-500">Secondaires :</span>
                            <div class="flex flex-wrap gap-1 mt-1" id="resume-secondaires"></div></div>
                        <div class="grid grid-cols-3 gap-2 mt-3">
                            <div class="stat-card"><div class="text-xs text-gray-500">Seuil scraping</div><div class="text-lg font-bold text-red-400" id="resume-seuil">2</div></div>
                            <div class="stat-card"><div class="text-xs text-gray-500">Seuil IA</div><div class="text-lg font-bold text-red-400" id="resume-seuil-ia">7</div></div>
                            <div class="stat-card"><div class="text-xs text-gray-500">Profondeur</div><div class="text-sm font-bold text-red-400" id="resume-profondeur">moyen</div></div>
                        </div>
                    </div>
                </div>

                <button onclick="lancerScraping()" id="btn-lancer-2" class="btn-primary w-full justify-center py-3 text-base">
                    <i data-lucide="play" class="w-5 h-5"></i>Lancer la recherche
                </button>
                <button onclick="stopScraping()" id="btn-stop" class="btn-secondary w-full justify-center hidden">
                    <i data-lucide="square" class="w-4 h-4"></i>Arr√™ter
                </button>

                <div class="card">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-300 flex items-center gap-2">
                            <i data-lucide="terminal" class="w-4 h-4 text-red-500"></i>Logs
                        </span>
                        <button onclick="clearLogs()" class="text-xs text-gray-500 hover:text-gray-300">Effacer</button>
                    </div>
                    <div id="logs-container" class="bg-gray-900 rounded border border-gray-700 p-3 overflow-y-auto" style="height:calc(100vh - 420px);min-height:300px">
                        <div class="log-entry text-gray-500">En attente de d√©marrage...</div>
                    </div>
                    <div class="mt-2">
                        <div class="h-1.5 bg-gray-700 rounded overflow-hidden">
                            <div id="progress-bar" class="h-full bg-red-600 transition-all duration-500" style="width:0%"></div>
                        </div>
                        <p id="progress-text" class="text-xs text-gray-500 mt-1 truncate"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB R√âSULTATS -->
    <div id="pane-resultats" class="tab-pane hidden">
        <div class="grid grid-cols-4 gap-4 mb-5">
            <div class="stat-card"><div class="text-xs text-gray-500 mb-1">Sites scrap√©s</div><div class="text-2xl font-bold text-white" id="stat-sites">0</div></div>
            <div class="stat-card"><div class="text-xs text-gray-500 mb-1">Documents trouv√©s</div><div class="text-2xl font-bold text-white" id="stat-docs">0</div></div>
            <div class="stat-card"><div class="text-xs text-gray-500 mb-1">Pertinents</div><div class="text-2xl font-bold text-green-400" id="stat-pertinents">0</div></div>
            <div class="stat-card"><div class="text-xs text-gray-500 mb-1">Taux</div><div class="text-2xl font-bold text-red-400" id="stat-taux">0%</div></div>
        </div>
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm font-semibold text-gray-300 flex items-center gap-2">
                    <i data-lucide="clock" class="w-4 h-4 text-red-500"></i>Historique des analyses
                </span>
                <button onclick="chargerHistorique()" class="btn-secondary text-xs py-1"><i data-lucide="refresh-cw" class="w-3 h-3"></i>Actualiser</button>
            </div>
            <table class="w-full text-sm">
                <thead><tr class="text-xs text-gray-500 uppercase border-b border-gray-700">
                    <th class="text-left py-2 pr-4">Date</th>
                    <th class="text-left py-2 pr-4">Cibles</th>
                    <th class="text-left py-2 pr-4">Documents</th>
                    <th class="text-left py-2">Pertinents</th>
                </tr></thead>
                <tbody id="history-table" class="divide-y divide-gray-800">
                    <tr><td colspan="4" class="py-4 text-center text-gray-600 text-xs">Aucune analyse lanc√©e</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB DOCUMENTS -->
    <div id="pane-documents" class="tab-pane hidden">
        <!-- Sous-onglets Documents -->
        <div class="flex gap-1 mb-4 border-b border-gray-700">
            <button class="tab-btn active" id="subtab-docs" onclick="showSubTab('docs')">üìÑ Documents analys√©s</button>
            <button class="tab-btn" id="subtab-validation" onclick="showSubTab('validation')">
                ‚úã Validation manuelle
                <span id="badge-pending" class="ml-1 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</span>
            </button>
        </div>

        <!-- Sous-pane : Documents analys√©s -->
        <div id="subpane-docs">
            <div class="card mb-4">
                <div class="flex flex-wrap gap-3 items-center">
                    <input type="text" id="doc-search" placeholder="Rechercher..." class="form-input flex-1 min-w-48 py-1.5 text-sm">
                    <select id="doc-score-filter" class="form-input w-44 py-1.5 text-sm">
                        <option value="">Tous les scores</option>
                        <option value="high">√âlev√© (7-10)</option>
                        <option value="medium">Moyen (4-6)</option>
                        <option value="low">Faible (0-3)</option>
                    </select>
                    <select id="doc-pertinence-filter" class="form-input w-44 py-1.5 text-sm">
                        <option value="">Tous</option>
                        <option value="true">Pertinents</option>
                        <option value="false">Non pertinents</option>
                    </select>
                    <select id="doc-maturite-filter" class="form-input w-52 py-1.5 text-sm">
                        <option value="reflexion">üü¢ Toutes maturit√©s</option>
                        <option value="etude">üü° √âtude+</option>
                        <option value="programmation">üü† Programmation+</option>
                        <option value="consultation">üî¥ Consultation imminente</option>
                    </select>
                    <button onclick="chargerDocuments()" class="btn-secondary text-sm py-1.5"><i data-lucide="refresh-cw" class="w-4 h-4"></i>Actualiser</button>
                    <button onclick="exporterResultats()" class="btn-secondary text-sm py-1.5"><i data-lucide="download" class="w-4 h-4"></i>Exporter</button>
                    <button onclick="purgerDocuments()" class="text-sm py-1.5 px-3 bg-red-900/40 text-red-400 border border-red-800 rounded-lg hover:bg-red-900/60 flex items-center gap-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>Purger
                    </button>
                </div>
            </div>
            <div id="docs-stats" class="grid grid-cols-4 gap-3 mb-4 hidden">
                <div class="stat-card"><div class="text-xs text-gray-500">Total</div><div class="text-xl font-bold text-white" id="d-total">0</div></div>
                <div class="stat-card"><div class="text-xs text-gray-500">Pertinents</div><div class="text-xl font-bold text-green-400" id="d-pertinents">0</div></div>
                <div class="stat-card"><div class="text-xs text-gray-500">Score moyen</div><div class="text-xl font-bold text-yellow-400" id="d-score">0.0</div></div>
                <div class="stat-card"><div class="text-xs text-gray-500">Taux</div><div class="text-xl font-bold text-red-400" id="d-taux">0%</div></div>
            </div>
            <div id="docs-loading" class="text-center py-12 text-gray-500"><i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin mb-2"></i>Chargement...</div>
            <div id="docs-empty" class="text-center py-12 text-gray-600 hidden"><i data-lucide="file-x" class="w-12 h-12 mx-auto mb-3"></i><p>Aucun document. Lancez une recherche d'abord.</p></div>
            <div id="docs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>
        </div>

        <!-- Sous-pane : Validation manuelle -->
        <div id="subpane-validation" class="hidden">
            <div class="card mb-4 flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-300">Documents d√©tect√©s par mots-cl√©s, <strong class="text-white">en attente de votre validation</strong>.</p>
                    <p class="text-xs text-gray-500 mt-1">Lisez l'extrait et d√©cidez si le document est pertinent pour votre campagne.</p>
                </div>
                <button onclick="chargerPending()" class="btn-secondary text-sm py-1.5 shrink-0"><i data-lucide="refresh-cw" class="w-4 h-4"></i>Actualiser</button>
            </div>
            <div id="pending-loading" class="text-center py-12 text-gray-500"><i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin mb-2"></i>Chargement...</div>
            <div id="pending-empty" class="text-center py-12 text-gray-600 hidden">
                <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-3 text-green-600"></i>
                <p>Aucun document en attente de validation.</p>
                <p class="text-xs mt-1">Lancez une recherche en mode "Validation manuelle" pour en voir appara√Ætre ici.</p>
            </div>
            <div id="pending-list" class="space-y-4 hidden"></div>
        </div>
    </div>

    </div><!-- fin .p-6 -->
</main>
<div id="toast" class="toast"></div>

<script>
// ‚îÄ‚îÄ Donn√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEPARTEMENTS = [
    {code:'01',nom:'Ain'},{code:'02',nom:'Aisne'},{code:'03',nom:'Allier'},
    {code:'04',nom:'Alpes-de-Haute-Provence'},{code:'05',nom:'Hautes-Alpes'},{code:'06',nom:'Alpes-Maritimes'},
    {code:'07',nom:'Ard√®che'},{code:'08',nom:'Ardennes'},{code:'09',nom:'Ari√®ge'},
    {code:'10',nom:'Aube'},{code:'11',nom:'Aude'},{code:'12',nom:'Aveyron'},
    {code:'13',nom:'Bouches-du-Rh√¥ne'},{code:'14',nom:'Calvados'},{code:'15',nom:'Cantal'},
    {code:'16',nom:'Charente'},{code:'17',nom:'Charente-Maritime'},{code:'18',nom:'Cher'},
    {code:'19',nom:'Corr√®ze'},{code:'21',nom:"C√¥te-d'Or"},{code:'22',nom:"C√¥tes-d'Armor"},
    {code:'23',nom:'Creuse'},{code:'24',nom:'Dordogne'},{code:'25',nom:'Doubs'},
    {code:'26',nom:'Dr√¥me'},{code:'27',nom:'Eure'},{code:'28',nom:'Eure-et-Loir'},
    {code:'29',nom:'Finist√®re'},{code:'2A',nom:'Corse-du-Sud'},{code:'2B',nom:'Haute-Corse'},
    {code:'30',nom:'Gard'},{code:'31',nom:'Haute-Garonne'},{code:'32',nom:'Gers'},
    {code:'33',nom:'Gironde'},{code:'34',nom:'H√©rault'},{code:'35',nom:'Ille-et-Vilaine'},
    {code:'36',nom:'Indre'},{code:'37',nom:'Indre-et-Loire'},{code:'38',nom:'Is√®re'},
    {code:'39',nom:'Jura'},{code:'40',nom:'Landes'},{code:'41',nom:'Loir-et-Cher'},
    {code:'42',nom:'Loire'},{code:'43',nom:'Haute-Loire'},{code:'44',nom:'Loire-Atlantique'},
    {code:'45',nom:'Loiret'},{code:'46',nom:'Lot'},{code:'47',nom:'Lot-et-Garonne'},
    {code:'48',nom:'Loz√®re'},{code:'49',nom:'Maine-et-Loire'},{code:'50',nom:'Manche'},
    {code:'51',nom:'Marne'},{code:'52',nom:'Haute-Marne'},{code:'53',nom:'Mayenne'},
    {code:'54',nom:'Meurthe-et-Moselle'},{code:'55',nom:'Meuse'},{code:'56',nom:'Morbihan'},
    {code:'57',nom:'Moselle'},{code:'58',nom:'Ni√®vre'},{code:'59',nom:'Nord'},
    {code:'60',nom:'Oise'},{code:'61',nom:'Orne'},{code:'62',nom:'Pas-de-Calais'},
    {code:'63',nom:'Puy-de-D√¥me'},{code:'64',nom:'Pyr√©n√©es-Atlantiques'},{code:'65',nom:'Hautes-Pyr√©n√©es'},
    {code:'66',nom:'Pyr√©n√©es-Orientales'},{code:'67',nom:'Bas-Rhin'},{code:'68',nom:'Haut-Rhin'},
    {code:'69',nom:'Rh√¥ne'},{code:'70',nom:'Haute-Sa√¥ne'},{code:'71',nom:'Sa√¥ne-et-Loire'},
    {code:'72',nom:'Sarthe'},{code:'73',nom:'Savoie'},{code:'74',nom:'Haute-Savoie'},
    {code:'75',nom:'Paris'},{code:'76',nom:'Seine-Maritime'},{code:'77',nom:'Seine-et-Marne'},
    {code:'78',nom:'Yvelines'},{code:'79',nom:'Deux-S√®vres'},{code:'80',nom:'Somme'},
    {code:'81',nom:'Tarn'},{code:'82',nom:'Tarn-et-Garonne'},{code:'83',nom:'Var'},
    {code:'84',nom:'Vaucluse'},{code:'85',nom:'Vend√©e'},{code:'86',nom:'Vienne'},
    {code:'87',nom:'Haute-Vienne'},{code:'88',nom:'Vosges'},{code:'89',nom:'Yonne'},
    {code:'90',nom:'Territoire de Belfort'},{code:'91',nom:'Essonne'},{code:'92',nom:'Hauts-de-Seine'},
    {code:'93',nom:'Seine-Saint-Denis'},{code:'94',nom:'Val-de-Marne'},{code:'95',nom:"Val-d'Oise"},
];

const REGIONS = {
    aura:['01','03','07','15','26','38','42','43','63','69','73','74'],
    idf: ['75','77','78','91','92','93','94','95'],
    occ: ['09','11','12','30','31','32','34','46','48','65','66','81','82'],
    naq: ['16','17','19','23','24','33','40','47','64','79','86','87'],
    bfc: ['21','25','39','58','70','71','89','90'],
    paca:['04','05','06','13','83','84'],
    bre: ['22','29','35','56'],
    nor: ['14','27','50','61','76'],
    hdf: ['02','59','60','62','80'],
    ges: ['08','10','51','52','54','55','57','67','68','88'],
    pdl: ['44','49','53','72','85'],
    cvl: ['18','28','36','37','41','45'],
};

// ‚îÄ‚îÄ Textes d'aide ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AIDE = {
    presets: {
        titre: 'üéØ Presets pr√©d√©finis',
        contenu: `<p>Les presets chargent automatiquement une configuration compl√®te adapt√©e √† un type de projet √©nerg√©tique :</p>
        <ul class="list-disc pl-4 mt-2 space-y-1">
            <li><strong class="text-red-400">Chaufferies Biomasse</strong> ‚Äî D√©tection de projets chaufferies bois/granul√©s/plaquettes</li>
            <li><strong class="text-yellow-400">Panneaux Solaires</strong> ‚Äî Photovolta√Øque, toiture solaire, autoconsommation</li>
            <li><strong class="text-orange-400">Pompes √† Chaleur</strong> ‚Äî PAC, g√©othermie, a√©rothermie</li>
            <li><strong class="text-blue-400">Bornes Recharge VE</strong> ‚Äî Mobilit√© √©lectrique, IRVE</li>
            <li><strong class="text-green-400">R√©novation B√¢timents</strong> ‚Äî Isolation, BBC, r√©novation √©nerg√©tique</li>
            <li><strong class="text-purple-400">üß™ Mode Test</strong> ‚Äî Mots-cl√©s larges et seuils √† 1 pour diagnostiquer le pipeline scraping</li>
        </ul>
        <p class="mt-2 text-gray-400 text-xs">Vous pouvez modifier les mots-cl√©s apr√®s avoir appliqu√© un preset.</p>`
    },
    mots_cles: {
        titre: 'üè∑Ô∏è Mots-cl√©s de d√©tection',
        contenu: `<p>Les mots-cl√©s sont utilis√©s pour <strong>scorer chaque page web</strong> visit√©e. Plus une page contient de mots-cl√©s, plus son score est √©lev√©.</p>
        <div class="mt-3 space-y-2">
            <div class="p-2 bg-red-900/20 rounded border border-red-800/40">
                <strong class="text-red-400">Prioritaires √ó 2 pts</strong><br>
                <span class="text-xs">Mots directement li√©s au projet. Ex: "chaufferie", "biomasse". Chaque occurrence rapporte 2 points.</span>
            </div>
            <div class="p-2 bg-yellow-900/20 rounded border border-yellow-800/40">
                <strong class="text-yellow-400">Secondaires √ó 1 pt</strong><br>
                <span class="text-xs">Mots associ√©s au contexte. Ex: "granul√©s", "plaquettes". 1 point chacun.</span>
            </div>
            <div class="p-2 bg-green-900/20 rounded border border-green-800/40">
                <strong class="text-green-400">Budget √ó 1 pt</strong><br>
                <span class="text-xs">Signaux d'intention budg√©taire. Ex: "subvention", "ADEME". 1 point chacun.</span>
            </div>
        </div>`
    },
    mots_prioritaires: {
        titre: 'üî¥ Mots-cl√©s prioritaires',
        contenu: `<p>Ces mots sont les <strong>signaux forts</strong> de votre recherche. Ils valent <strong>2 points</strong> chacun dans le score de pertinence.</p>
        <p class="mt-2">Utilisez des termes tr√®s sp√©cifiques √† votre projet :</p>
        <ul class="list-disc pl-4 mt-1 text-xs space-y-1">
            <li>Noms techniques pr√©cis (ex: "chaufferie biomasse")</li>
            <li>Acronymes officiels (ex: "ADEME", "CEE")</li>
            <li>Termes r√©glementaires (ex: "r√©seau de chaleur")</li>
        </ul>
        <p class="mt-2 text-xs text-gray-400">‚ö†Ô∏è √âvitez les mots trop g√©n√©riques qui g√©n√©reraient du bruit.</p>`
    },
    mots_secondaires: {
        titre: 'üü° Mots-cl√©s secondaires',
        contenu: `<p>Ces mots sont des <strong>signaux contextuels</strong> qui confirment l'int√©r√™t d'une page. Ils valent <strong>1 point</strong> chacun.</p>
        <p class="mt-2 text-xs">Exemples : technologies associ√©es, mat√©riaux, √©quipements p√©riph√©riques.</p>
        <p class="mt-2 text-xs text-gray-400">Une page avec uniquement des mots secondaires peut quand m√™me √™tre pertinente si le seuil est bas.</p>`
    },
    mots_budget: {
        titre: 'üü¢ Mots-cl√©s budget',
        contenu: `<p>Ces mots signalent une <strong>intention de financement ou d'investissement</strong>. Ils valent <strong>1 point</strong> chacun.</p>
        <p class="mt-2 text-xs">Exemples : "budget", "cr√©dit", "subvention", "fonds chaleur", "ADEME", "CEE", "investissement".</p>
        <p class="mt-2 text-xs text-gray-400">üí° Astuce : les d√©lib√©rations municipales mentionnent souvent les montants et sources de financement ‚Äî ces mots permettent de les cibler.</p>`
    },
    seuils: {
        titre: '‚öñÔ∏è Seuils de d√©tection',
        contenu: `<p>Les seuils d√©finissent √† partir de quel score un document est consid√©r√© comme <strong>pertinent</strong>.</p>
        <div class="mt-3 space-y-3">
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-red-400">Seuil scraping</strong> ‚Äî Filtre rapide par mots-cl√©s<br>
                <span class="text-xs">Appliqu√© pendant le scraping. Les pages avec un score inf√©rieur sont ignor√©es imm√©diatement.</span>
            </div>
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-red-400">Seuil IA</strong> ‚Äî Filtre par analyse TinyLlama/Ollama<br>
                <span class="text-xs">Appliqu√© apr√®s l'analyse IA. Les documents avec un score IA inf√©rieur sont exclus des r√©sultats.</span>
            </div>
        </div>`
    },
    seuil_scraping: {
        titre: 'üîç Seuil minimum scraping',
        contenu: `<p>Ce seuil est appliqu√© <strong>en temps r√©el pendant le scraping</strong>, avant toute analyse IA.</p>
        <div class="mt-2 space-y-1 text-xs">
            <div class="flex items-center gap-2"><span class="help-tag" style="background:#374151;color:#9ca3af">1 ‚Äî Large</span> Toutes les pages avec au moins 1 mot-cl√©</div>
            <div class="flex items-center gap-2"><span class="help-tag" style="background:#7f1d1d;color:#fca5a5">2 ‚Äî Recommand√©</span> Bon √©quilibre pr√©cision/rappel</div>
            <div class="flex items-center gap-2"><span class="help-tag" style="background:#991b1b;color:#fca5a5">3-4 ‚Äî Strict</span> Uniquement les pages tr√®s cibl√©es</div>
            <div class="flex items-center gap-2"><span class="help-tag" style="background:#b91c1c;color:#fca5a5">5 ‚Äî Tr√®s strict</span> Risque de manquer des opportunit√©s</div>
        </div>
        <p class="mt-2 text-xs text-gray-400">‚ö° Un seuil bas = plus de pages analys√©es = plus lent mais plus complet.</p>`
    },
    seuil_ia: {
        titre: 'ü§ñ Seuil IA minimum (/10)',
        contenu: `<p>Score minimum attribu√© par l'IA (TinyLlama/Ollama) pour qu'un document soit conserv√© dans les r√©sultats.</p>
        <div class="mt-2 space-y-1 text-xs">
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">1-4</span> Pertinence faible ‚Äî beaucoup de faux positifs</div>
            <div><span class="help-tag" style="background:#7f1d1d;color:#fca5a5">5-6</span> Pertinence moyenne</div>
            <div><span class="help-tag" style="background:#991b1b;color:#fca5a5">7 ‚Äî Recommand√©</span> Bonne pertinence</div>
            <div><span class="help-tag" style="background:#b91c1c;color:#fca5a5">8-10</span> Tr√®s pertinent ‚Äî risque de manquer des projets</div>
        </div>
        <p class="mt-2 text-xs text-gray-400">L'IA √©value le document sur 10 en analysant son contenu complet.</p>`
    },
    params_scraping: {
        titre: '‚öôÔ∏è Param√®tres de scraping',
        contenu: `<p>Ces param√®tres contr√¥lent le <strong>comportement technique</strong> du scraper lors de la visite des sites municipaux.</p>`
    },
    delai: {
        titre: '‚è±Ô∏è D√©lai entre requ√™tes',
        contenu: `<p>Temps d'attente entre chaque requ√™te HTTP vers un m√™me site.</p>
        <div class="mt-2 space-y-1 text-xs">
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">0.5s</span> Rapide ‚Äî risque de blocage par le serveur</div>
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">1.5s ‚Äî Recommand√©</span> Bon √©quilibre vitesse/respect</div>
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">3s+</span> Lent mais tr√®s respectueux</div>
        </div>
        <p class="mt-2 text-xs text-gray-400">‚ö†Ô∏è Un d√©lai trop court peut d√©clencher des protections anti-bot et bloquer votre IP.</p>`
    },
    timeout: {
        titre: '‚è≥ Timeout',
        contenu: `<p>Dur√©e maximale d'attente pour qu'un site r√©ponde avant d'abandonner la requ√™te.</p>
        <ul class="list-disc pl-4 mt-2 text-xs space-y-1">
            <li><strong>10s</strong> ‚Äî Sites rapides (h√©bergement moderne)</li>
            <li><strong>30s ‚Äî Recommand√©</strong> ‚Äî Sites municipaux souvent lents</li>
            <li><strong>60s+</strong> ‚Äî Sites tr√®s lents ou instables</li>
        </ul>
        <p class="mt-2 text-xs text-gray-400">Les sites municipaux peuvent √™tre h√©berg√©s sur des serveurs anciens avec des temps de r√©ponse √©lev√©s.</p>`
    },
    profondeur: {
        titre: 'üî¨ Profondeur de scraping',
        contenu: `<p>D√©finit combien de pages sont visit√©es sur chaque site municipal.</p>
        <div class="mt-2 space-y-2 text-xs">
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-green-400">L√©ger</strong> ‚Äî Page d'accueil uniquement<br>
                <span class="text-gray-400">Rapide (~5s/site). D√©tecte seulement les projets tr√®s visibles.</span>
            </div>
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-yellow-400">Moyen ‚Äî Recommand√©</strong> ‚Äî Accueil + sections principales<br>
                <span class="text-gray-400">~30s/site. Visite actualit√©s, d√©lib√©rations, march√©s publics.</span>
            </div>
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-red-400">Profond</strong> ‚Äî Toutes les sous-pages<br>
                <span class="text-gray-400">Lent (~2-5min/site). Analyse exhaustive, d√©tecte les signaux faibles.</span>
            </div>
        </div>`
    },
    sites_scraper: {
        titre: 'üåê Sites √† scraper',
        contenu: `<p>Deux modes pour d√©finir les sites municipaux √† analyser :</p>
        <div class="mt-2 space-y-2 text-xs">
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-blue-400">URLs manuelles</strong><br>
                Entrez directement les URLs des sites. Id√©al pour cibler des communes pr√©cises ou tester.
            </div>
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-red-400">Par d√©partement</strong><br>
                S√©lectionnez des d√©partements sur la carte. Le scraper trouvera automatiquement les URLs de toutes les communes ‚â• population minimale.
            </div>
        </div>`
    },
    population_min: {
        titre: 'üë• Population minimale',
        contenu: `<p>Filtre les communes par nombre d'habitants. Seules les communes avec une population <strong>sup√©rieure ou √©gale</strong> √† ce seuil seront scrap√©es.</p>
        <div class="mt-2 space-y-1 text-xs">
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">500 hab.</span> Toutes les communes (tr√®s long)</div>
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">2 000 hab.</span> Communes rurales et semi-rurales</div>
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">5 000 hab. ‚Äî Recommand√©</span> Bon √©quilibre</div>
            <div><span class="help-tag" style="background:#374151;color:#9ca3af">10 000+ hab.</span> Villes moyennes uniquement</div>
        </div>
        <p class="mt-2 text-xs text-gray-400">üí° Les communes de plus de 3 500 hab. ont l'obligation de publier leurs d√©lib√©rations en ligne.</p>`
    },
    regions: {
        titre: 'üó∫Ô∏è S√©lection par r√©gion',
        contenu: `<p>S√©lectionne automatiquement <strong>tous les d√©partements</strong> d'une r√©gion administrative fran√ßaise.</p>
        <p class="mt-2 text-xs">Vous pouvez ensuite d√©s√©lectionner individuellement certains d√©partements sur la carte.</p>
        <p class="mt-2 text-xs text-gray-400">Les r√©gions disponibles couvrent la France m√©tropolitaine. Les DOM-TOM ne sont pas encore support√©s.</p>`
    },
    ia_mode: {
        titre: 'ü§ñ Mode d\'analyse IA',
        contenu: `<p>Choisissez comment les documents d√©tect√©s par mots-cl√©s seront analys√©s pour confirmer leur pertinence.</p>
        <div class="mt-3 space-y-3">
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-gray-200">ü§ñ IA locale (TinyLlama)</strong><br>
                <span class="text-xs">Analyse sur votre machine via Ollama. Priv√©, fonctionne hors-ligne. Recommand√© : TinyLlama 1B (l√©ger, adapt√© MacBook Air M1).</span>
            </div>
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-gray-200">‚òÅÔ∏è API Groq</strong><br>
                <span class="text-xs">Analyse dans le cloud via l'API Groq. Tr√®s rapide, gratuit jusqu'√† 30 req/min. N√©cessite une cl√© API (gratuite sur <strong>console.groq.com</strong>). Mod√®le recommand√© : Llama 3 8B.</span>
            </div>
            <div class="p-2 bg-gray-800 rounded">
                <strong class="text-gray-200">‚úã Validation manuelle</strong><br>
                <span class="text-xs">Aucune IA utilis√©e. Les documents d√©tect√©s par mots-cl√©s apparaissent dans l'onglet <strong>Documents ‚Üí Validation manuelle</strong> pour que vous d√©cidiez vous-m√™me de leur pertinence.</span>
            </div>
        </div>
        <p class="mt-2 text-xs text-gray-400">üí° La config IA est sauvegard√©e ind√©pendamment de la campagne et persiste entre les sessions.</p>`
    },
};

// ‚îÄ‚îÄ Modal aide ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aide(key) {
    const data = AIDE[key];
    if (!data) return;
    document.getElementById('help-title').textContent = data.titre;
    document.getElementById('help-body').innerHTML = data.contenu;
    document.getElementById('help-overlay').classList.add('open');
}
function fermerAide(e) {
    if (!e || e.target === document.getElementById('help-overlay')) {
        document.getElementById('help-overlay').classList.remove('open');
    }
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') fermerAide(); });

// ‚îÄ‚îÄ √âtat global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let presetsData = {};
let pollingInterval = null;
let currentMode = 'single';
let allDocs = [];
let deptsSelectionnes = new Set();
let carteInitialisee = false;
let iaCfg = { mode: 'local', model: 'tinyllama', groq_api_key: '', groq_model: 'llama3-8b-8192' };

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    await Promise.all([chargerConfig(), chargerPresets(), chargerConfigIA()]);
    chargerDocuments();
    chargerHistorique();
    chargerPending();
    bindDocFilters();
});

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(name) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('pane-' + name)?.classList.remove('hidden');
    document.getElementById('tab-' + name)?.classList.add('active');
    if (name === 'lancement') mettreAJourResume();
    if (name === 'documents') { chargerDocuments(); chargerPending(); }
    if (name === 'resultats') chargerHistorique();
}

// ‚îÄ‚îÄ Mode URL / D√©partement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(mode) {
    currentMode = mode;
    document.getElementById('mode-single-panel').classList.toggle('hidden', mode !== 'single');
    document.getElementById('mode-dept-panel').classList.toggle('hidden', mode !== 'department');
    document.getElementById('mode-single').classList.toggle('active', mode === 'single');
    document.getElementById('mode-dept').classList.toggle('active', mode === 'department');
    if (mode === 'department' && !carteInitialisee) {
        setTimeout(initCarteD3, 100);
    }
}
</script>

<script>
// ‚îÄ‚îÄ Carte D3.js avec GeoJSON officiel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initCarteD3() {
    if (carteInitialisee) { mettreAJourCouleurs(); return; }
    carteInitialisee = true;

    const container = document.getElementById('carte-container');
    const svg = d3.select('#carte-svg');
    svg.selectAll('*').remove();

    const W = container.clientWidth || 700;
    const H = container.clientHeight || 520;
    svg.attr('viewBox', `0 0 ${W} ${H}`).attr('preserveAspectRatio', 'xMidYMid meet');

    // Charger GeoJSON officiel des d√©partements fran√ßais
    let geojson;
    try {
        const r = await fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson');
        geojson = await r.json();
    } catch(e) {
        svg.append('text').attr('x', W/2).attr('y', H/2)
            .attr('text-anchor','middle').attr('fill','#6b7280').attr('font-size','12')
            .text('Carte non disponible (r√©seau requis)');
        return;
    }

    // fitSize ajuste automatiquement la projection pour que TOUS les d√©partements
    // (Corse incluse) rentrent dans le conteneur avec une marge de 12px
    const projection = d3.geoConicConformal().center([2.454071, 46.279229]);
    const path = d3.geoPath().projection(projection);
    projection.fitExtent([[12, 12], [W - 12, H - 12]], {type: 'FeatureCollection', features: geojson.features});
    const tooltip = document.getElementById('carte-tooltip-d3');

    const g = svg.append('g');

    g.selectAll('path')
        .data(geojson.features)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('data-code', d => d.properties.code)
        .attr('fill', d => deptsSelectionnes.has(d.properties.code) ? '#dc2626' : '#374151')
        .attr('stroke', '#1f2937')
        .attr('stroke-width', '0.5')
        .on('click', function(event, d) {
            const code = d.properties.code;
            if (deptsSelectionnes.has(code)) deptsSelectionnes.delete(code);
            else deptsSelectionnes.add(code);
            mettreAJourCouleurs();
            mettreAJourListe();
        })
        .on('mousemove', function(event, d) {
            const code = d.properties.code;
            const nom = d.properties.nom;
            const rect = container.getBoundingClientRect();
            tooltip.textContent = code + ' ‚Äî ' + nom;
            tooltip.style.left = (event.clientX - rect.left + 12) + 'px';
            tooltip.style.top = (event.clientY - rect.top - 28) + 'px';
            tooltip.classList.remove('hidden');
            d3.select(this).attr('fill', deptsSelectionnes.has(code) ? '#ef4444' : '#1e3a5f');
        })
        .on('mouseleave', function(event, d) {
            tooltip.classList.add('hidden');
            const code = d.properties.code;
            d3.select(this).attr('fill', deptsSelectionnes.has(code) ? '#dc2626' : '#374151');
        });

    // Labels num√©ros de d√©partement
    g.selectAll('text')
        .data(geojson.features)
        .enter()
        .append('text')
        .attr('transform', d => {
            const c = path.centroid(d);
            return isNaN(c[0]) ? null : `translate(${c})`;
        })
        .attr('text-anchor', 'middle')
        .attr('dy', '0.35em')
        .attr('font-size', d => {
            // Paris et petits depts : plus petit
            return ['75','92','93','94'].includes(d.properties.code) ? '5' : '7';
        })
        .attr('fill', d => deptsSelectionnes.has(d.properties.code) ? '#fff' : '#9ca3af')
        .attr('pointer-events', 'none')
        .attr('data-label', d => d.properties.code)
        .text(d => d.properties.code);

    mettreAJourListe();
}

function mettreAJourCouleurs() {
    d3.selectAll('#carte-svg path').attr('fill', function() {
        const code = d3.select(this).attr('data-code');
        return deptsSelectionnes.has(code) ? '#dc2626' : '#374151';
    });
    d3.selectAll('#carte-svg text[data-label]').attr('fill', function() {
        const code = d3.select(this).attr('data-label');
        return deptsSelectionnes.has(code) ? '#fff' : '#9ca3af';
    });
    mettreAJourListe();
}

function mettreAJourListe() {
    const list = document.getElementById('depts-selectionnes');
    const nb = document.getElementById('nb-depts-sel');
    if (!list) return;
    const sel = [...deptsSelectionnes].sort();
    nb.textContent = sel.length;
    list.innerHTML = sel.map(code => {
        const d = DEPARTEMENTS.find(x => x.code === code);
        return `<div class="flex items-center justify-between text-xs py-0.5">
            <span class="text-gray-300"><span class="font-mono text-red-400 mr-1">${code}</span>${d ? d.nom.substring(0,14) : ''}</span>
            <button onclick="retirerDept('${code}')" class="text-gray-600 hover:text-red-400 ml-1 text-base leading-none">&times;</button>
        </div>`;
    }).join('') || '<span class="text-xs text-gray-600">Aucun s√©lectionn√©</span>';
}

function retirerDept(code) {
    deptsSelectionnes.delete(code);
    mettreAJourCouleurs();
}

function selectionnerRegion(key) {
    if (!key) return;
    (REGIONS[key] || []).forEach(c => deptsSelectionnes.add(c));
    mettreAJourCouleurs();
    document.getElementById('region-select').value = '';
}

function deselectionnerTout() {
    deptsSelectionnes.clear();
    mettreAJourCouleurs();
}

// Compat avec remplir()
function genererDepts(sel) {
    deptsSelectionnes = new Set(sel);
    if (carteInitialisee) mettreAJourCouleurs();
}
function getDepts() { return [...deptsSelectionnes]; }

// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function chargerConfig() {
    try {
        const r = await fetch('/api/config/search');
        if (!r.ok) return;
        remplir(await r.json());
    } catch(e) {}
}
async function chargerPresets() {
    try {
        const r = await fetch('/api/config/presets');
        if (r.ok) presetsData = await r.json();
    } catch(e) {}
}

function remplir(cfg) {
    document.getElementById('nom_campagne').value = cfg.nom_campagne || '';
    document.getElementById('description').value = cfg.description || '';
    document.getElementById('date_debut_recherche').value = cfg.date_debut_recherche || '';
    document.getElementById('header-campagne-nom').textContent = cfg.nom_campagne || '‚Äî';
    const mk = cfg.mots_cles || {};
    document.getElementById('mots_prioritaires').value = (mk.prioritaires||[]).join('\n');
    document.getElementById('mots_secondaires').value = (mk.secondaires||[]).join('\n');
    document.getElementById('mots_budget').value = (mk.budget||[]).join('\n');
    const z = cfg.zones_geographiques || {};
    genererDepts(z.departements || []);
    const minPop = document.getElementById('dept-min-pop');
    if (minPop) minPop.value = z.population_min ?? 5000;
    const p = cfg.parametres_scraping || {};
    const sc = p.seuil_confiance_min ?? 2;
    document.getElementById('seuil_confiance').value = sc;
    document.getElementById('seuil_label').textContent = sc;
    document.getElementById('delai_requetes').value = p.delai_entre_requetes ?? 1.5;
    document.getElementById('timeout').value = p.timeout ?? 30;
    document.getElementById('profondeur').value = p.profondeur || 'moyen';
    const si = cfg.seuil_ia ?? 7;
    document.getElementById('seuil_ia').value = si;
    document.getElementById('seuil_ia_label').textContent = si;
    // Fen√™tre temporelle
    const fen = cfg.fenetre_temporelle ?? 90;
    setFenetre(fen);
    // Signaux faibles
    const sf = cfg.signaux_faibles_actifs || {};
    document.getElementById('sf-budgetaires').checked = sf.budgetaires !== false;
    document.getElementById('sf-reflexion').checked   = sf.reflexion   !== false;
    document.getElementById('sf-consultation').checked = sf.consultation !== false;
    // Maturit√© minimale
    document.getElementById('maturite_min').value = cfg.maturite_min || 'reflexion';
}

function lireFormulaire() {
    const lignes = id => document.getElementById(id).value.split('\n').map(s=>s.trim()).filter(Boolean);
    return {
        nom_campagne: document.getElementById('nom_campagne').value.trim(),
        description: document.getElementById('description').value.trim(),
        date_debut_recherche: document.getElementById('date_debut_recherche').value,
        mots_cles: {
            prioritaires: lignes('mots_prioritaires'),
            secondaires: lignes('mots_secondaires'),
            budget: lignes('mots_budget'),
        },
        zones_geographiques: {
            departements: getDepts(),
            population_min: parseInt(document.getElementById('dept-min-pop')?.value)||500,
            population_max: 200000,
        },
        parametres_scraping: {
            seuil_confiance_min: parseInt(document.getElementById('seuil_confiance').value),
            delai_entre_requetes: parseFloat(document.getElementById('delai_requetes').value),
            timeout: parseInt(document.getElementById('timeout').value),
            profondeur: document.getElementById('profondeur').value,
        },
        seuil_ia: parseInt(document.getElementById('seuil_ia').value),
        fenetre_temporelle: parseInt(document.getElementById('fenetre_temporelle').value) || 90,
        signaux_faibles_actifs: {
            budgetaires:  document.getElementById('sf-budgetaires').checked,
            reflexion:    document.getElementById('sf-reflexion').checked,
            consultation: document.getElementById('sf-consultation').checked,
        },
        maturite_min: document.getElementById('maturite_min').value,
    };
}

function mettreAJourResume() {
    const cfg = lireFormulaire();
    document.getElementById('resume-nom').textContent = cfg.nom_campagne || '‚Äî';
    const tag = (m, cls) => `<span class="text-xs px-2 py-0.5 rounded-full ${cls}">${m}</span>`;
    document.getElementById('resume-prioritaires').innerHTML =
        cfg.mots_cles.prioritaires.map(m => tag(m,'bg-red-900/50 text-red-300')).join('') || '<span class="text-xs text-gray-600">aucun</span>';
    document.getElementById('resume-secondaires').innerHTML =
        cfg.mots_cles.secondaires.map(m => tag(m,'bg-gray-700 text-gray-400')).join('') || '<span class="text-xs text-gray-600">aucun</span>';
    document.getElementById('resume-seuil').textContent = cfg.parametres_scraping.seuil_confiance_min;
    document.getElementById('resume-seuil-ia').textContent = cfg.seuil_ia;
    document.getElementById('resume-profondeur').textContent = cfg.parametres_scraping.profondeur;
}

async function sauvegarder() {
    const cfg = lireFormulaire();
    if (!cfg.nom_campagne) { showToast('Nom de campagne obligatoire','error'); return; }
    if (!cfg.mots_cles.prioritaires.length) { showToast('Au moins un mot-cl√© prioritaire requis','error'); return; }
    try {
        const r = await fetch('/api/config/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(cfg)});
        const data = await r.json();
        if (r.ok) { document.getElementById('header-campagne-nom').textContent = cfg.nom_campagne; showToast('Configuration sauvegard√©e !','success'); }
        else showToast('Erreur : '+(data.error||'Inconnue'),'error');
    } catch(e) { showToast('Erreur r√©seau','error'); }
}

async function resetConfig() {
    if (!confirm('R√©initialiser avec les valeurs par d√©faut ?')) return;
    try {
        const r = await fetch('/api/config/search/reset',{method:'POST'});
        const data = await r.json();
        if (r.ok) { remplir(data.config); showToast('Config r√©initialis√©e','success'); }
    } catch(e) { showToast('Erreur r√©seau','error'); }
}

const PRESET_TEST = {
    nom_campagne: 'TEST - Validation pipeline',
    description: 'Mode diagnostic ‚Äî seuils bas et mots-cl√©s larges pour valider le pipeline.',
    mots_cles: {
        prioritaires: ['√©nergie','travaux','projet','budget','investissement'],
        secondaires:  ['r√©novation','√©quipement','b√¢timent','commune','municipal'],
        budget:       ['financement','subvention','cr√©dit','d√©pense'],
    },
    zones_geographiques: { departements: [], population_min: 0, population_max: 9999999 },
    parametres_scraping: {
        seuil_confiance_min: 1,
        delai_entre_requetes: 1.5,
        timeout: 30,
        profondeur: 'moyen',
    },
    seuil_ia: 1,
    fenetre_temporelle: 365,
    signaux_faibles_actifs: { budgetaires: true, reflexion: true, consultation: true },
    maturite_min: 'reflexion',
    ia_mode: 'manual',
};

function appliquerPreset(key, btn) {
    document.querySelectorAll('.preset-btn, .preset-btn-test').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (key === 'custom') {
        ['nom_campagne','description','mots_prioritaires','mots_secondaires','mots_budget'].forEach(id => document.getElementById(id).value='');
        return;
    }
    if (key === 'mode_test') {
        remplir(PRESET_TEST);
        // Forcer mode IA manuel
        const manualRadio = document.querySelector('input[name="ia_mode"][value="manual"]');
        if (manualRadio) { manualRadio.checked = true; manualRadio.dispatchEvent(new Event('change')); }
        showToast('üß™ Mode Test activ√© ‚Äî seuils bas, fen√™tre 365j', 'success');
        return;
    }
    const p = presetsData[key];
    if (!p) { showToast('Preset non disponible','error'); return; }
    remplir(p);
    showToast('Preset "'+p.nom_campagne+'" appliqu√©','success');
}

// ‚îÄ‚îÄ Lancer scraping ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function lancerScraping() {
    const cfg = lireFormulaire();
    if (!cfg.nom_campagne || !cfg.mots_cles.prioritaires.length) {
        showToast('Configurez la campagne avant de lancer','error');
        showTab('config'); return;
    }
    await sauvegarder();
    let crawlingConfig = { mode: currentMode };
    if (currentMode === 'single') {
        const urls = document.getElementById('urls-input').value.split('\n').map(u=>u.trim()).filter(Boolean);
        if (!urls.length) { showToast("Entrez au moins une URL dans l'onglet Lancement",'error'); showTab('lancement'); return; }
        crawlingConfig.predefined_urls = urls;
    } else {
        // Utiliser communesData si disponible (URLs v√©rifi√©es), sinon fallback sur les depts
        if (communesData.length > 0) {
            const urlsOk = communesData
                .filter(c => c.url_status !== 'ko')
                .map(c => c.url_retenue)
                .filter(Boolean);
            if (!urlsOk.length) { showToast('Aucune URL accessible ‚Äî v√©rifiez la disponibilit√©','error'); return; }
            crawlingConfig.mode = 'single';
            crawlingConfig.predefined_urls = urlsOk;
            // Passer aussi les m√©tadonn√©es communes pour le backend
            crawlingConfig.communes_meta = communesData
                .filter(c => c.url_status !== 'ko')
                .map(c => ({ nom: c.nom, population: c.population, url: c.url_retenue }));
        } else {
            const depts = getDepts();
            if (!depts.length) { showToast('S√©lectionnez au moins un d√©partement sur la carte','error'); return; }
            crawlingConfig.department = {
                codes: depts,
                min_population: parseInt(document.getElementById('dept-min-pop').value)||0,
            };
        }
    }
    const payload = {
        crawling: crawlingConfig,
        ai: {
            mode: iaCfg.mode,
            model: iaCfg.model,
            groq_api_key: iaCfg.groq_api_key,
            groq_model: iaCfg.groq_model,
            search_depth: cfg.parametres_scraping.profondeur,
            score_threshold: cfg.seuil_ia,
        },
        filtering: { energy_keywords: [...cfg.mots_cles.prioritaires,...cfg.mots_cles.secondaires,...cfg.mots_cles.budget] }
    };
    setBtnState(true);
    showTab('lancement');
    clearLogs();
    addLog('üöÄ D√©marrage de la recherche...','info');
    document.getElementById('progress-bar').style.width = '5%';
    try {
        const r = await fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if (r.ok) demarrerPolling();
        else { addLog('‚ùå Erreur au d√©marrage','error'); setBtnState(false); }
    } catch(e) { addLog('‚ùå Erreur r√©seau : '+e.message,'error'); setBtnState(false); }
}

function stopScraping() {
    if (pollingInterval) { clearInterval(pollingInterval); pollingInterval=null; }
    setBtnState(false);
    addLog('‚èπ Arr√™t√© par l\'utilisateur','warning');
}

function setBtnState(running) {
    ['btn-lancer','btn-lancer-2'].forEach(id => { const b=document.getElementById(id); if(b) b.disabled=running; });
    const stop = document.getElementById('btn-stop');
    if (stop) stop.classList.toggle('hidden',!running);
}

function demarrerPolling() {
    let progress = 5;
    pollingInterval = setInterval(async () => {
        try {
            const r = await fetch('/api/status');
            const data = await r.json();
            if (data.status === 'no_update') return;
            const type = data.status==='error'?'error':data.status==='warning'?'warning':data.status==='completed'?'success':'info';
            addLog(data.message||'',type);
            if (data.status==='running' && progress<90) progress=Math.min(90,progress+2);
            document.getElementById('progress-bar').style.width=progress+'%';
            document.getElementById('progress-text').textContent=(data.message||'').slice(0,80);
            if (data.status==='completed'||data.status==='error') {
                clearInterval(pollingInterval); pollingInterval=null;
                document.getElementById('progress-bar').style.width=data.status==='completed'?'100%':progress+'%';
                setBtnState(false);
                if (data.status==='completed') { showToast('Recherche termin√©e !','success'); chargerDocuments(); chargerHistorique(); }
            }
        } catch(e) {}
    }, 800);
}

function addLog(msg,type='info') {
    const colors={info:'text-blue-400',success:'text-green-400',warning:'text-yellow-400',error:'text-red-400'};
    const c=document.getElementById('logs-container');
    const d=document.createElement('div');
    d.className='log-entry '+(colors[type]||'text-gray-300');
    d.textContent='['+new Date().toLocaleTimeString('fr-FR')+'] '+msg;
    c.appendChild(d); c.scrollTop=c.scrollHeight;
    while(c.children.length>200) c.removeChild(c.firstChild);
}
function clearLogs() { document.getElementById('logs-container').innerHTML='<div class="log-entry text-gray-600">Logs effac√©s.</div>'; }

async function chargerCommunesAuvergne() {
    const minPop=document.getElementById('auvergne-min-pop').value||5000;
    try {
        const r=await fetch('/api/communes/auvergne?min_population='+minPop);
        if(!r.ok){showToast('Erreur chargement communes','error');return;}
        const data=await r.json();
        const urls=(data.communes||data).map(c=>c.url||c.website||'').filter(Boolean);
        document.getElementById('urls-input').value=urls.join('\n');
        showToast(urls.length+' communes charg√©es','success');
    } catch(e){showToast('Erreur : '+e.message,'error');}
}

async function chargerDocuments() {
    document.getElementById('docs-loading').classList.remove('hidden');
    document.getElementById('docs-grid').classList.add('hidden');
    document.getElementById('docs-empty').classList.add('hidden');
    try {
        const r=await fetch('/api/documents');
        if(!r.ok) throw new Error('HTTP '+r.status);
        allDocs=await r.json();
        afficherDocuments(allDocs);
    } catch(e) { document.getElementById('docs-loading').classList.add('hidden'); document.getElementById('docs-empty').classList.remove('hidden'); }
}

const MATURITE_ORDER = ['reflexion','etude','programmation','consultation'];

function maturiteIndex(m) { return MATURITE_ORDER.indexOf(m ?? 'reflexion'); }

function scoreTooltip(d) {
    const sd = d.score_details || {};
    if (!Object.keys(sd).length) return '';
    const lines = [
        sd.fraicheur   != null ? `Fra√Æcheur : ${sd.fraicheur >= 0 ? '+' : ''}${sd.fraicheur} pt` : null,
        sd.pertinence_kw != null ? `Mots-cl√©s : +${sd.pertinence_kw} pts` : null,
        sd.signaux_faibles != null ? `Signaux faibles : +${sd.signaux_faibles} pts` : null,
        sd.source      != null ? `Source : +${sd.source} pt` : null,
        sd.maturite    != null ? `Maturit√© : +${sd.maturite} pts` : null,
        `= Total : ${sd.total ?? d.score_composite ?? '?'}`,
    ].filter(Boolean).join('&#10;');
    return `title="${lines}"`;
}

function maturiteBadge(d) {
    const m = d.maturite || 'reflexion';
    const emoji = d.maturite_emoji || 'üü¢';
    const label = d.maturite_label || 'R√©flexion';
    const delai = d.maturite_delai || '';
    const cls = {reflexion:'bg-green-900/30 text-green-400', etude:'bg-yellow-900/30 text-yellow-400',
                  programmation:'bg-orange-900/30 text-orange-400', consultation:'bg-red-900/40 text-red-400'}[m] || 'bg-gray-700 text-gray-400';
    return `<span class="text-xs px-1.5 py-0.5 rounded ${cls}" title="${delai}">${emoji} ${label}</span>`;
}

function sourceBadgeDoc(d) {
    const src = d.source_type || 'generique';
    const label = d.source_label || src;
    const cls = {rss:'bg-blue-900/40 text-blue-300', deliberation:'bg-purple-900/40 text-purple-300',
                  actualites:'bg-teal-900/40 text-teal-300', bulletin:'bg-indigo-900/40 text-indigo-300',
                  generique:'bg-gray-700 text-gray-500'}[src] || 'bg-gray-700 text-gray-500';
    return `<span class="text-xs px-1.5 py-0.5 rounded ${cls}">${label}</span>`;
}

function signalBadges(d) {
    const cats = d.categories_signaux || [];
    const map = {budgetaires:'üí∞', reflexion:'üü¢', consultation:'üî¥'};
    return cats.map(c => `<span class="text-xs px-1 py-0.5 rounded bg-gray-700 text-gray-400">${map[c]||'üìå'} ${c}</span>`).join('');
}

function afficherDocuments(docs) {
    document.getElementById('docs-loading').classList.add('hidden');
    const search  = document.getElementById('doc-search').value.toLowerCase();
    const scoreF  = document.getElementById('doc-score-filter').value;
    const pertF   = document.getElementById('doc-pertinence-filter').value;
    const maturF  = document.getElementById('doc-maturite-filter')?.value || 'reflexion';

    let filtered = docs.filter(d => {
        if (search && !((d.title||d.nom_fichier||'').toLowerCase().includes(search)
            || (d.ia_resume||'').toLowerCase().includes(search)
            || (d.commune||'').toLowerCase().includes(search))) return false;
        if (scoreF === 'high'   && d.ia_score < 7) return false;
        if (scoreF === 'medium' && (d.ia_score < 4 || d.ia_score > 6)) return false;
        if (scoreF === 'low'    && d.ia_score > 3) return false;
        if (pertF === 'true'    && !d.ia_pertinent) return false;
        if (pertF === 'false'   && d.ia_pertinent)  return false;
        if (maturiteIndex(d.maturite) < maturiteIndex(maturF)) return false;
        return true;
    });

    // Tri par score composite d√©croissant
    filtered.sort((a, b) => (b.score_composite ?? b.score ?? 0) - (a.score_composite ?? a.score ?? 0));

    const total = filtered.length;
    const pertinents = filtered.filter(d => d.ia_pertinent).length;
    const avgScore = total ? (filtered.reduce((s,d) => s + (d.score_composite ?? d.ia_score ?? 0), 0) / total).toFixed(1) : '0.0';
    document.getElementById('d-total').textContent = total;
    document.getElementById('d-pertinents').textContent = pertinents;
    document.getElementById('d-score').textContent = avgScore;
    document.getElementById('d-taux').textContent = total ? Math.round(pertinents/total*100)+'%' : '0%';
    document.getElementById('docs-stats').classList.toggle('hidden', total === 0);

    if (!total) {
        document.getElementById('docs-empty').classList.remove('hidden');
        document.getElementById('docs-grid').classList.add('hidden');
        return;
    }
    document.getElementById('docs-empty').classList.add('hidden');
    document.getElementById('docs-grid').classList.remove('hidden');

    document.getElementById('docs-grid').innerHTML = filtered.map(d => {
        const iaScore = d.ia_score || 0;
        const compScore = d.score_composite ?? d.score ?? 0;
        const ok = d.ia_pertinent;
        const sc = iaScore >= 7 ? 'text-green-400' : iaScore >= 4 ? 'text-yellow-400' : 'text-gray-500';
        const bc = ok ? 'border-green-800' : 'border-gray-700';
        const dateStr = d.date_publication
            ? new Date(d.date_publication).toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric'})
            : null;
        return `<div class="card-sm border ${bc}">
            <div class="flex items-start justify-between mb-1.5 gap-2">
                <p class="text-sm font-medium text-gray-200 truncate flex-1">${d.commune ? `<span class="text-xs text-gray-500 mr-1">${d.commune}</span>` : ''}${d.title||d.nom_fichier||'Sans titre'}</p>
                <span class="text-base font-bold ${sc} shrink-0 cursor-help" ${scoreTooltip(d)}>${compScore > 0 ? '+' : ''}${compScore}</span>
            </div>
            <div class="flex flex-wrap gap-1 mb-1.5">
                ${maturiteBadge(d)}
                ${sourceBadgeDoc(d)}
                ${signalBadges(d)}
            </div>
            <p class="text-xs text-gray-500 mb-1.5 truncate">${d.source_url||d.site_url||''}</p>
            ${d.ia_resume ? `<p class="text-xs text-gray-400 mb-1.5 line-clamp-2">${d.ia_resume}</p>` : ''}
            <div class="flex items-center gap-2 mt-2 flex-wrap">
                <span class="text-xs px-1.5 py-0.5 rounded-full ${ok ? 'bg-green-900/50 text-green-400' : 'bg-gray-700 text-gray-500'}">${ok ? '‚úì Pertinent' : 'Non pertinent'}</span>
                ${iaScore > 0 ? `<span class="text-xs text-gray-600">IA: ${iaScore}/10</span>` : ''}
                ${dateStr ? `<span class="text-xs text-gray-600">üìÖ ${dateStr}</span>` : ''}
                ${d.source_url ? `<a href="${d.source_url}" target="_blank" class="ml-auto text-xs text-blue-400 hover:underline">Voir ‚Üí</a>` : ''}
            </div>
        </div>`;
    }).join('');
    lucide.createIcons();
}

function bindDocFilters() {
    ['doc-search','doc-score-filter','doc-pertinence-filter','doc-maturite-filter'].forEach(id=>{
        document.getElementById(id)?.addEventListener('input',()=>afficherDocuments(allDocs));
        document.getElementById(id)?.addEventListener('change',()=>afficherDocuments(allDocs));
    });
}

async function exporterResultats() {
    try {
        const r=await fetch('/api/export');
        if(r.ok){const blob=await r.blob(),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='hardscrapper_'+new Date().toISOString().slice(0,10)+'.json';a.click();URL.revokeObjectURL(url);}
    } catch(e){showToast('Erreur export','error');}
}

async function purgerDocuments() {
    if(!confirm('Supprimer tous les documents analys√©s ?')) return;
    try {
        const r=await fetch('/api/documents/purge',{method:'DELETE'});
        if(r.ok){showToast('Documents purg√©s','success');chargerDocuments();}
    } catch(e){showToast('Erreur purge','error');}
}

async function chargerHistorique() {
    try {
        const r=await fetch('/api/history');
        if(!r.ok) return;
        const history=await r.json();
        const tbody=document.getElementById('history-table');
        if(!history.length){tbody.innerHTML='<tr><td colspan="4" class="py-4 text-center text-gray-600 text-xs">Aucune analyse lanc√©e</td></tr>';return;}
        const last=history[history.length-1],res=last.results||{};
        document.getElementById('stat-sites').textContent=res.target_info||'‚Äî';
        document.getElementById('stat-docs').textContent=res.documents_processed||0;
        document.getElementById('stat-pertinents').textContent=res.relevant_found||0;
        const t=res.documents_processed||0,p=res.relevant_found||0;
        document.getElementById('stat-taux').textContent=t?Math.round(p/t*100)+'%':'0%';
        tbody.innerHTML=[...history].reverse().slice(0,20).map(h=>{
            const r=h.results||{},date=new Date(h.timestamp).toLocaleString('fr-FR');
            return `<tr class="text-xs text-gray-400"><td class="py-2 pr-4">${date}</td><td class="py-2 pr-4">${r.target_info||'‚Äî'}</td><td class="py-2 pr-4">${r.documents_processed||0}</td><td class="py-2"><span class="text-green-400 font-medium">${r.relevant_found||0}</span></td></tr>`;
        }).join('');
    } catch(e){}
}

function showToast(msg,type) {
    const t=document.getElementById('toast');
    t.textContent=msg;t.className='toast '+type;t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),3500);
}

// ‚îÄ‚îÄ Fen√™tre temporelle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setFenetre(jours) {
    document.getElementById('fenetre_temporelle').value = jours;
    document.querySelectorAll('.fenetre-btn').forEach(b => {
        const isActive = b.id === `fen-${jours}`;
        b.classList.toggle('border-red-600', isActive);
        b.classList.toggle('text-red-400', isActive);
        b.classList.toggle('bg-red-900/20', isActive);
        b.classList.toggle('border-gray-600', !isActive);
        b.classList.toggle('text-gray-400', !isActive);
    });
}

// ‚îÄ‚îÄ Communes par d√©partement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let communesData = []; // [{nom, population, url_retenue, url_status, urls_candidates}]

function setPopFilter(min, max) {
    document.getElementById('dept-min-pop').value = min;
    document.getElementById('dept-max-pop').value = max === 9999999 ? 9999999 : max;
    document.querySelectorAll('.pop-filter-btn').forEach(b => {
        const bMin = parseInt(b.dataset.min), bMax = parseInt(b.dataset.max);
        b.classList.toggle('active-pop', bMin === min && bMax === max);
    });
}

async function chargerCommunesDept() {
    const depts = getDepts();
    if (!depts.length) { showToast('S√©lectionnez au moins un d√©partement sur la carte', 'error'); return; }
    const popMin = parseInt(document.getElementById('dept-min-pop').value) || 0;
    const popMax = parseInt(document.getElementById('dept-max-pop').value) || 9999999;

    const btn = document.getElementById('btn-charger-communes');
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i>Chargement...';
    lucide.createIcons();

    communesData = [];
    try {
        for (const code of depts) {
            const r = await fetch(`/api/communes/departement?code=${code}&pop_min=${popMin}&pop_max=${popMax}`);
            if (r.ok) {
                const d = await r.json();
                communesData.push(...(d.communes || []));
            }
        }
        communesData.sort((a, b) => b.population - a.population);
        rendreCommunesList();
        document.getElementById('communes-panel').classList.remove('hidden');
        document.getElementById('validate-stats').classList.add('hidden');
        showToast(`${communesData.length} commune(s) charg√©e(s)`, 'success');
    } catch(e) {
        showToast('Erreur chargement communes : ' + e.message, 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<i data-lucide="download" class="w-3 h-3"></i>Charger les communes';
    lucide.createIcons();
}

// ‚îÄ‚îÄ Helpers statut ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STATUS_LABELS = {
    confirmed:  { icon: '‚úÖ', label: 'Confirm√©e',   cls: 'confirmed' },
    uncertain:  { icon: '‚ö†Ô∏è', label: 'Incertaine',  cls: 'uncertain' },
    not_found:  { icon: '‚ùå', label: 'Non trouv√©e', cls: 'not_found' },
    manual:     { icon: '‚úã', label: '√Ä v√©rifier',  cls: 'manual' },
    checking:   { icon: 'üîÑ', label: 'En cours‚Ä¶',   cls: 'checking' },
    unknown:    { icon: 'üîµ', label: 'Non v√©rifi√©e',cls: 'unknown' },
};
const SOURCE_LABELS = {
    pattern: 'Pattern', groq: 'Groq', manual: 'Manuel',
    none: '‚Äî', groq_failed: 'Groq ‚úó',
};

function statusBadge(status) {
    const s = STATUS_LABELS[status] || STATUS_LABELS.unknown;
    return `<span class="status-badge ${s.cls}">${s.icon} ${s.label}</span>`;
}
function sourceBadge(source) {
    const src = source || 'none';
    return `<span class="source-badge ${src}">${SOURCE_LABELS[src] || src}</span>`;
}

function rendreCommunesList() {
    const tbody = document.getElementById('communes-tbody');
    const count = document.getElementById('communes-count');
    if (!tbody) return;
    count.textContent = communesData.length;
    if (!communesData.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">Aucune commune charg√©e.</td></tr>';
        return;
    }
    tbody.innerHTML = communesData.map((c, i) => {
        const st = c.url_status || 'unknown';
        const url = c.url_retenue || '';
        return `<tr class="status-${st}" id="crow-${i}">
            <td class="py-1.5 pr-3 font-medium text-gray-200 whitespace-nowrap">${c.nom}</td>
            <td class="py-1.5 pr-3 text-gray-400 whitespace-nowrap">${c.population ? c.population.toLocaleString('fr-FR') : '?'}</td>
            <td class="py-1.5 pr-3" style="min-width:200px;max-width:260px">
                <input class="url-edit-input" id="url-inp-${i}" value="${url}"
                    onchange="communesData[${i}].url_retenue=this.value;communesData[${i}].url_status='unknown';communesData[${i}].url_source='manual';mettreAJourLigne(${i})"
                    title="${url}">
            </td>
            <td class="py-1.5 pr-3" id="status-cell-${i}">${statusBadge(st)}</td>
            <td class="py-1.5 pr-3" id="source-cell-${i}">${sourceBadge(c.url_source)}</td>
            <td class="py-1.5">
                <div class="flex gap-1">
                    <button onclick="revaliderLigne(${i})" title="Revalider" class="text-gray-500 hover:text-blue-400 transition-colors">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    </button>
                    <button onclick="retirerCommune(${i})" title="Retirer" class="text-gray-500 hover:text-red-400 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            </td>
        </tr>`;
    }).join('');
    lucide.createIcons();
    mettreAJourStatsValidation();
}

function mettreAJourLigne(i) {
    const c = communesData[i];
    const row = document.getElementById(`crow-${i}`);
    if (!row) return;
    row.className = `status-${c.url_status || 'unknown'}`;
    const sc = document.getElementById(`status-cell-${i}`);
    const src = document.getElementById(`source-cell-${i}`);
    if (sc) sc.innerHTML = statusBadge(c.url_status || 'unknown');
    if (src) src.innerHTML = sourceBadge(c.url_source);
    mettreAJourStatsValidation();
}

function mettreAJourStatsValidation() {
    const counts = { confirmed: 0, uncertain: 0, not_found: 0, unknown: 0, checking: 0, manual: 0 };
    communesData.forEach(c => { const k = c.url_status || 'unknown'; counts[k] = (counts[k]||0) + 1; });
    const el = id => document.getElementById(id);
    if (el('vs-confirmed')) el('vs-confirmed').textContent = counts.confirmed;
    if (el('vs-uncertain')) el('vs-uncertain').textContent = counts.uncertain;
    if (el('vs-notfound'))  el('vs-notfound').textContent  = counts.not_found;
    if (el('vs-unknown'))   el('vs-unknown').textContent   = counts.unknown + counts.checking;
    const hasNotFound = counts.not_found > 0;
    el('btn-groq-search')?.classList.toggle('hidden', !hasNotFound);
    el('btn-suppr-nf')?.classList.toggle('hidden', !hasNotFound);
    document.getElementById('validate-stats')?.classList.remove('hidden');
}

function changerURL(i, url) {
    if (communesData[i]) { communesData[i].url_retenue = url; communesData[i].url_source = 'manual'; }
}

function retirerCommune(i) {
    communesData.splice(i, 1);
    rendreCommunesList();
}

function ajouterURLManuelle() {
    const inp  = document.getElementById('add-url-input');
    const nom  = document.getElementById('add-nom-input');
    const url  = inp.value.trim();
    if (!url || !url.startsWith('http')) { showToast('URL invalide (doit commencer par http)', 'error'); return; }
    communesData.push({
        nom: nom?.value.trim() || url.replace(/https?:\/\//, ''),
        population: 0, url_retenue: url,
        urls_candidates: [url], url_status: 'unknown', url_source: 'manual'
    });
    rendreCommunesList();
    inp.value = ''; if (nom) nom.value = '';
}

// ‚îÄ‚îÄ √âtape 1 : Validation patterns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function validerURLsPatterns() {
    if (!communesData.length) return;
    const btn = document.getElementById('btn-valider-patterns');
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i>Validation‚Ä¶';
    lucide.createIcons();

    const prog    = document.getElementById('validate-progress');
    const progBar = document.getElementById('validate-progress-bar');
    const progPct = document.getElementById('validate-progress-pct');
    const progTxt = document.getElementById('validate-progress-text');
    prog.classList.remove('hidden');

    // Marquer tout en checking
    communesData.forEach(c => { c.url_status = 'checking'; c.url_source = c.url_source || 'none'; });
    rendreCommunesList();

    const batchSize = 8;
    let done = 0;
    for (let start = 0; start < communesData.length; start += batchSize) {
        const batch = communesData.slice(start, start + batchSize);
        try {
            const r = await fetch('/api/communes/validate-urls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ communes: batch, timeout: 5 })
            });
            if (r.ok) {
                const data = await r.json();
                data.results.forEach((res, j) => {
                    const idx = start + j;
                    communesData[idx] = { ...communesData[idx], ...res };
                    mettreAJourLigne(idx);
                    // Mettre √† jour l'input URL
                    const inp = document.getElementById(`url-inp-${idx}`);
                    if (inp) inp.value = res.url_retenue || '';
                });
            }
        } catch(e) {}
        done += batch.length;
        const pct = Math.round(done / communesData.length * 100);
        progBar.style.width = pct + '%';
        progPct.textContent = pct + '%';
        progTxt.textContent = `${done}/${communesData.length} communes v√©rifi√©es`;
    }

    prog.classList.add('hidden');
    btn.disabled = false;
    btn.innerHTML = '<i data-lucide="search" class="w-3 h-3"></i>√âtape 1 ‚Äî Valider patterns';
    lucide.createIcons();

    const nf = communesData.filter(c => c.url_status === 'not_found').length;
    const ok = communesData.filter(c => c.url_status === 'confirmed').length;
    showToast(`‚úÖ ${ok} confirm√©es, ‚ùå ${nf} non trouv√©es`, nf > ok ? 'error' : 'success');
}

// ‚îÄ‚îÄ √âtape 2 : Groq sur non trouv√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function lancerGroqSurNonTrouves() {
    const nonTrouves = communesData.filter(c => c.url_status === 'not_found');
    if (!nonTrouves.length) { showToast('Aucune commune non trouv√©e', 'error'); return; }

    const btn = document.getElementById('btn-groq-search');
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i>Groq en cours‚Ä¶';
    lucide.createIcons();

    const prog    = document.getElementById('validate-progress');
    const progBar = document.getElementById('validate-progress-bar');
    const progPct = document.getElementById('validate-progress-pct');
    const progTxt = document.getElementById('validate-progress-text');
    prog.classList.remove('hidden');
    progBar.style.width = '0%';
    progTxt.textContent = `Groq : recherche pour ${nonTrouves.length} communes‚Ä¶`;

    // Marquer en checking
    nonTrouves.forEach(c => {
        const idx = communesData.indexOf(c);
        communesData[idx].url_status = 'checking';
        mettreAJourLigne(idx);
    });

    const batchSize = 5;
    let done = 0;
    for (let start = 0; start < nonTrouves.length; start += batchSize) {
        const batch = nonTrouves.slice(start, start + batchSize);
        try {
            const r = await fetch('/api/communes/groq-search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    communes: batch,
                    groq_api_key: iaCfg.groq_api_key,
                    groq_model: iaCfg.groq_model || 'llama-3.3-70b-versatile',
                    timeout: 5
                })
            });
            if (r.ok) {
                const data = await r.json();
                if (data.error) { showToast('Groq : ' + data.error, 'error'); break; }
                data.results.forEach(res => {
                    const idx = communesData.findIndex(c => c.nom === res.nom);
                    if (idx >= 0) {
                        communesData[idx] = { ...communesData[idx], ...res };
                        mettreAJourLigne(idx);
                        const inp = document.getElementById(`url-inp-${idx}`);
                        if (inp) inp.value = res.url_retenue || '';
                    }
                });
            }
        } catch(e) {}
        done += batch.length;
        const pct = Math.round(done / nonTrouves.length * 100);
        progBar.style.width = pct + '%';
        progPct.textContent = pct + '%';
        progTxt.textContent = `Groq : ${done}/${nonTrouves.length} trait√©es`;
    }

    prog.classList.add('hidden');
    btn.disabled = false;
    btn.innerHTML = '<i data-lucide="sparkles" class="w-3 h-3"></i>√âtape 2 ‚Äî Groq sur non trouv√©es';
    lucide.createIcons();

    const ok = communesData.filter(c => c.url_status === 'confirmed' && c.url_source === 'groq').length;
    showToast(`Groq : ${ok} URL(s) trouv√©e(s) et confirm√©e(s)`, ok > 0 ? 'success' : 'error');
}

// ‚îÄ‚îÄ Revalider une ligne ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function revaliderLigne(i) {
    const c = communesData[i];
    communesData[i].url_status = 'checking';
    mettreAJourLigne(i);
    try {
        const r = await fetch('/api/communes/validate-urls', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ communes: [{ ...c, urls_candidates: [c.url_retenue] }], timeout: 5 })
        });
        if (r.ok) {
            const data = await r.json();
            if (data.results?.[0]) {
                communesData[i] = { ...communesData[i], ...data.results[0] };
                const inp = document.getElementById(`url-inp-${i}`);
                if (inp) inp.value = communesData[i].url_retenue || '';
            }
        }
    } catch(e) { communesData[i].url_status = 'unknown'; }
    mettreAJourLigne(i);
}

function supprimerNonTrouves() {
    const avant = communesData.length;
    communesData = communesData.filter(c => c.url_status !== 'not_found');
    rendreCommunesList();
    showToast(`${avant - communesData.length} commune(s) non trouv√©e(s) retir√©e(s)`, 'success');
}

// Alias pour compat avec l'ancien code
function supprimerInaccessibles() { supprimerNonTrouves(); }
function verifierURLs() { validerURLsPatterns(); }

// ‚îÄ‚îÄ Config IA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function chargerConfigIA() {
    try {
        const r = await fetch('/api/config/ia');
        if (r.ok) {
            iaCfg = await r.json();
            // Appliquer dans l'UI
            const radio = document.querySelector(`input[name="ia_mode"][value="${iaCfg.mode}"]`);
            if (radio) { radio.checked = true; onIaModeChange(iaCfg.mode, false); }
            if (iaCfg.groq_api_key) document.getElementById('groq-api-key').value = iaCfg.groq_api_key;
            if (iaCfg.groq_model) document.getElementById('groq-model').value = iaCfg.groq_model;
            if (iaCfg.model) document.getElementById('local-model').value = iaCfg.model;
        }
    } catch(e) {}
}

function onIaModeChange(mode, save=true) {
    iaCfg.mode = mode;
    document.getElementById('ia-groq-options').classList.toggle('hidden', mode !== 'groq');
    document.getElementById('ia-local-options').classList.toggle('hidden', mode !== 'local');
    // Highlight du label actif
    ['local','groq','manuel'].forEach(m => {
        const lbl = document.getElementById(`ia-mode-${m}-lbl`);
        if (lbl) lbl.classList.toggle('border-red-600', m === mode);
    });
    if (save) sauvegarderConfigIA();
}

async function sauvegarderConfigIA() {
    iaCfg = {
        mode: document.querySelector('input[name="ia_mode"]:checked')?.value || 'local',
        model: document.getElementById('local-model').value,
        groq_api_key: document.getElementById('groq-api-key').value,
        groq_model: document.getElementById('groq-model').value,
    };
    try {
        await fetch('/api/config/ia', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(iaCfg)});
        showToast('Config IA sauvegard√©e','success');
    } catch(e) { showToast('Erreur sauvegarde config IA','error'); }
}

// ‚îÄ‚îÄ Sous-onglets Documents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSubTab(name) {
    ['docs','validation'].forEach(n => {
        document.getElementById('subpane-'+n)?.classList.toggle('hidden', n !== name);
        const btn = document.getElementById('subtab-'+n);
        if (btn) { btn.classList.toggle('active', n === name); }
    });
    if (name === 'validation') chargerPending();
}

// ‚îÄ‚îÄ Validation manuelle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function chargerPending() {
    const loading = document.getElementById('pending-loading');
    const empty   = document.getElementById('pending-empty');
    const list    = document.getElementById('pending-list');
    const badge   = document.getElementById('badge-pending');
    if (!loading) return;
    loading.classList.remove('hidden'); empty.classList.add('hidden'); list.classList.add('hidden');
    try {
        const r = await fetch('/api/documents/pending');
        const docs = r.ok ? await r.json() : [];
        loading.classList.add('hidden');
        if (!docs.length) {
            empty.classList.remove('hidden');
            badge.classList.add('hidden');
            return;
        }
        badge.textContent = docs.length;
        badge.classList.remove('hidden');
        list.classList.remove('hidden');
        list.innerHTML = docs.map(d => `
            <div class="card" id="pending-card-${d.id}">
                <div class="flex items-start justify-between gap-3 mb-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap mb-1">
                            <span class="text-xs font-bold text-red-400">${d.commune || '‚Äî'} (${d.departement || '‚Äî'})</span>
                            <span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded">${d.document_type || 'html'}</span>
                            <span class="text-xs text-gray-500">Score mots-cl√©s : <strong class="text-yellow-400">${d.score}</strong></span>
                        </div>
                        <p class="text-sm text-white font-medium truncate">${d.title}</p>
                        ${d.source_url ? `<a href="${d.source_url}" target="_blank" class="text-xs text-blue-400 hover:underline truncate block">${d.source_url}</a>` : ''}
                    </div>
                </div>
                ${d.mots_trouves?.length ? `<div class="flex flex-wrap gap-1 mb-3">${d.mots_trouves.map(m=>`<span class="text-xs bg-red-900/40 text-red-300 px-1.5 py-0.5 rounded">${m}</span>`).join('')}</div>` : ''}
                <div class="bg-gray-900 rounded p-3 mb-3 text-xs text-gray-400 font-mono leading-relaxed max-h-32 overflow-y-auto">${(d.texte_extrait||'Aucun extrait disponible').replace(/</g,'&lt;')}</div>
                <div class="flex items-center gap-2 flex-wrap">
                    <label class="text-xs text-gray-400">Note :</label>
                    <input type="text" id="note-${d.id}" placeholder="Optionnel..." class="form-input flex-1 text-xs py-1">
                    <label class="text-xs text-gray-400">Score :</label>
                    <input type="number" id="score-${d.id}" value="8" min="1" max="10" class="form-input w-16 text-xs py-1">
                    <button onclick="validerDoc('${d.file}',${d.index},'${d.id}',true)" class="btn-primary text-xs py-1.5 px-3">
                        <i data-lucide="check" class="w-3 h-3"></i>Pertinent
                    </button>
                    <button onclick="validerDoc('${d.file}',${d.index},'${d.id}',false)" class="btn-secondary text-xs py-1.5 px-3 border-red-800 text-red-400">
                        <i data-lucide="x" class="w-3 h-3"></i>Non pertinent
                    </button>
                </div>
            </div>`).join('');
        lucide.createIcons();
    } catch(e) {
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
    }
}

async function validerDoc(file, index, cardId, decision) {
    const note  = document.getElementById('note-'+cardId)?.value || '';
    const score = parseInt(document.getElementById('score-'+cardId)?.value || '8');
    try {
        const r = await fetch('/api/documents/validate', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({file, index, decision, score, note})
        });
        if (r.ok) {
            const card = document.getElementById('pending-card-'+cardId);
            if (card) {
                card.style.opacity = '0.4';
                card.style.pointerEvents = 'none';
                const msg = decision
                    ? '<div class="text-xs text-green-400 font-semibold mt-2">‚úÖ Marqu√© comme pertinent</div>'
                    : '<div class="text-xs text-gray-500 font-semibold mt-2">‚ùå Marqu√© comme non pertinent</div>';
                card.insertAdjacentHTML('beforeend', msg);
            }
            showToast(decision ? '‚úÖ Document valid√© comme pertinent' : '‚ùå Document rejet√©', decision ? 'success' : 'error');
            // Mettre √† jour le badge
            const badge = document.getElementById('badge-pending');
            if (badge) {
                const n = parseInt(badge.textContent||'0') - 1;
                badge.textContent = n;
                if (n <= 0) badge.classList.add('hidden');
            }
        } else {
            showToast('Erreur lors de la validation','error');
        }
    } catch(e) { showToast('Erreur r√©seau','error'); }
}
</script>
</body>
</html>
